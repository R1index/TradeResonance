{% extends "base.html" %}
{% block content %}
<section class="card p-4">
  <h1 class="text-xl font-semibold mb-3">{{ title }}</h1>

  <form method="post" enctype="multipart/form-data" class="grid grid-cols-1 md:grid-cols-4 gap-3" id="entryForm">
    <input type="hidden" name="next" value="{{ next_url or request.referrer }}">

    {# —Å–∫—Ä—ã—Ç—ã–π _action —É–±—Ä–∞–Ω ‚Äî –¥–µ–π—Å—Ç–≤–∏–µ –≤—ã–±–∏—Ä–∞–µ—Ç—Å—è –∫–Ω–æ–ø–∫–∞–º–∏ –Ω–∏–∂–µ #}

    <!-- –ì–æ—Ä–æ–¥ + –û—á–∏—Å—Ç–∏—Ç—å (—Ç–æ–ª—å–∫–æ –≤ —Ä–µ–∂–∏–º–µ —Å–æ–∑–¥–∞–Ω–∏—è) -->
    <div class="md:col-span-2">
      <div class="flex items-center justify-between">
        <label class="label">{{ t('city') }}</label>
        {% if not e %}
        <button type="button" class="btn btn-outline px-2 py-1 text-xs" data-clear="#cityField">
          {{ 'Clear' if lang=='en' else '–û—á–∏—Å—Ç–∏—Ç—å' }}
        </button>
        {% endif %}
      </div>
      {% if e %}
        <input id="cityField" name="city" class="input bg-gray-100" value="{{ e.city }}" readonly>
      {% else %}
        <input
          id="cityField"
          name="city"
          class="input"
          list="citiesList"
          autocomplete="off" spellcheck="false"
          value="{{ request.form.get('city','') or request.args.get('city','') }}"
          required>
        <datalist id="citiesList">
          {% for c in cities_list %}<option value="{{ c }}">{% endfor %}
        </datalist>
      {% endif %}
    </div>

    <!-- –¢–æ–≤–∞—Ä + –û—á–∏—Å—Ç–∏—Ç—å (—Ç–æ–ª—å–∫–æ –≤ —Ä–µ–∂–∏–º–µ —Å–æ–∑–¥–∞–Ω–∏—è) -->
    <div class="md:col-span-2">
      <div class="flex items-center justify-between">
        <label class="label">{{ t('product') }}</label>
        {% if not e %}
        <button type="button" class="btn btn-outline px-2 py-1 text-xs" data-clear="#productField">
          {{ 'Clear' if lang=='en' else '–û—á–∏—Å—Ç–∏—Ç—å' }}
        </button>
        {% endif %}
      </div>
      {% if e %}
        <input id="productField" name="product" class="input bg-gray-100" value="{{ e.product }}" readonly>
      {% else %}
        <input
          id="productField"
          name="product"
          class="input"
          autocomplete="off" spellcheck="false"
          data-product-autocomplete
          value="{{ request.form.get('product','') }}"
          required>
      {% endif %}
    </div>

    {% if e %}
    <!-- –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞ -->
    <div class="md:col-span-2">
      <label class="label">{{ t('product_image') }}</label>
      <div class="flex flex-wrap items-center gap-4">
        <div class="product-thumb product-thumb--large">
          {% if e.image_path %}
            <img src="{{ url_for('static', filename=e.image_path) }}" alt="{{ e.product }}">
          {% else %}
            <span>üì¶</span>
          {% endif %}
        </div>
        <div class="flex-1 min-w-[12rem] space-y-1">
          <input type="file" name="image" accept="image/*" class="input-file">
          <p class="text-xs text-[var(--muted)]">{{ t('product_image_hint') }}</p>
        </div>
      </div>
    </div>
    {% endif %}

    <!-- –¶–µ–Ω–∞ + –û—á–∏—Å—Ç–∏—Ç—å + –¶–∏—Ñ—Ä–æ–≤–∞—è –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞ -->
    <div>
      <div class="flex items-center justify-between">
        <label class="label">{{ t('price') }}</label>
        <button type="button" class="btn btn-outline px-2 py-1 text-xs" data-clear="#priceField">
          {{ 'Clear' if lang=='en' else '–û—á–∏—Å—Ç–∏—Ç—å' }}
        </button>
      </div>
      <input id="priceField" type="number" step="1" name="price" class="input mb-2"
             value="{% if e %}{{ (overrides.price if overrides is defined and overrides.price is not none else e.price) | default('', true) }}{% else %}{{ request.form.get('price','') }}{% endif %}"
             {% if not e %}required{% endif %}>

      <!-- –¶–∏—Ñ—Ä–æ–≤–∞—è –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –¥–ª—è —Ü–µ–Ω—ã (—Ç–æ–ª—å–∫–æ –Ω–∞ –¥–µ—Å–∫—Ç–æ–ø–µ) -->
      <div class="hidden md:grid grid-cols-3 gap-1 mb-2">
        {% for i in range(1, 10) %}
        <button type="button" class="btn btn-outline p-1 text-sm" data-input="#priceField" data-value="{{ i }}">{{ i }}</button>
        {% endfor %}
        <button type="button" class="btn btn-outline p-1 text-sm" data-input="#priceField" data-value="0">0</button>
        <button type="button" class="btn btn-outline p-1 text-sm" data-backspace="#priceField">‚å´</button>
      </div>
    </div>

    <!-- –ü—Ä–æ—Ü–µ–Ω—Ç + –û—á–∏—Å—Ç–∏—Ç—å + –¶–∏—Ñ—Ä–æ–≤–∞—è –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞ -->
    <div>
      <div class="flex items-center justify-between">
        <label class="label">{{ t('percent') }} %</label>
        <button type="button" class="btn btn-outline px-2 py-1 text-xs" data-clear="#percentField">
          {{ 'Clear' if lang=='en' else '–û—á–∏—Å—Ç–∏—Ç—å' }}
        </button>
      </div>
      <input id="percentField" type="number" step="1" name="percent" class="input mb-2"
             value="{% if e %}{{ (overrides.percent if overrides is defined and overrides.percent is not none else e.percent) | default('0', true) }}{% else %}{{ request.form.get('percent','0') }}{% endif %}"
             {% if not e %}required{% endif %}>

      <!-- –¶–∏—Ñ—Ä–æ–≤–∞—è –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –¥–ª—è –ø—Ä–æ—Ü–µ–Ω—Ç–æ–≤ (—Ç–æ–ª—å–∫–æ –Ω–∞ –¥–µ—Å–∫—Ç–æ–ø–µ) -->
      <div class="hidden md:grid grid-cols-3 gap-1 mb-2">
        {% for i in range(1, 10) %}
        <button type="button" class="btn btn-outline p-1 text-sm" data-input="#percentField" data-value="{{ i }}">{{ i }}</button>
        {% endfor %}
        <button type="button" class="btn btn-outline p-1 text-sm" data-input="#percentField" data-value="0">0</button>
        <button type="button" class="btn btn-outline p-1 text-sm" data-backspace="#percentField">‚å´</button>
      </div>
    </div>

    <!-- –¢—Ä–µ–Ω–¥ + —Å—Ç—Ä–µ–ª–∫–∏ -->
    <div>
      <div class="flex items-center justify-between">
        <label class="label">{{ t('trend') }}</label>
        <div class="flex gap-1">
          <button type="button" class="btn btn-outline px-2 py-1 text-xs" data-trend="up" title="{{ t('up') }}">‚ñ≤</button>
          <button type="button" class="btn btn-outline px-2 py-1 text-xs" data-trend="down" title="{{ t('down') }}">‚ñº</button>
        </div>
      </div>
      {% set cur_trend = (overrides.trend if e and overrides is defined and overrides.trend else (e.trend if e else request.form.get('trend'))) or ('up') %}
      <select id="trendSelect" name="trend" class="select" required>
        <option value="up"   {{ 'selected' if cur_trend=='up'   else '' }}>{{ t('up') }}</option>
        <option value="down" {{ 'selected' if cur_trend=='down' else '' }}>{{ t('down') }}</option>
      </select>
    </div>

    <!-- –ü—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–µ–Ω–Ω—ã–π –≥–æ—Ä–æ–¥ -->
    <div class="flex items-end">
      <label class="inline-flex items-center gap-2">
        <input type="checkbox" class="h-4 w-4" name="is_production_city"
               {% if e %}
                 {% if e.is_production_city %}checked{% endif %}
               {% else %}
                 {% if request.form.get('is_production_city') %}checked{% endif %}
               {% endif %}
               {% if e %}disabled{% endif %}>
        <span class="label">{{ t('is_prod_city') }}</span>
        {% if e %}
          <span class="text-xs opacity-70">({{ t('cannot_edit') if t('cannot_edit') else 'Cannot edit' }})</span>
        {% endif %}
      </label>
    </div>

    <!-- –ö–Ω–æ–ø–∫–∏ -->
    <div class="md:col-span-4 flex flex-wrap items-center gap-2 pt-2">
      {% if e %}
        <button class="btn btn-primary" id="submitBtn" type="submit">{{ t('save') }}</button>
      {% else %}
        <button class="btn btn-outline" type="submit" name="_action" value="find_existing" formnovalidate>
          {{ 'submit/find' if lang=='en' else 'submit/find' }}
        </button>
        <button class="btn btn-primary" id="submitBtn" type="submit" name="_action" value="submit_request">
          {{ t('submit') if t('submit') else 'Submit' }}
        </button>
      {% endif %}
      <a class="btn btn-outline" href="{{ next_url or request.referrer or url_for('index', lang=lang) }}">‚Üê {{ t('back') }}</a>
      {% if e %}
      <div class="flex flex-wrap items-center gap-2 ml-auto">
        <input type="password" name="admin_pass" class="input" placeholder="{{ t('admin_password') }}" autocomplete="off" style="width: 14rem;">
        <button class="btn btn-danger" type="submit" name="_action" value="delete" onclick="return confirm({{ t('confirm_delete')|tojson }});">{{ t('delete') }}</button>
      </div>
      {% endif %}
    </div>
  </form>

  <!-- –°–ø–∏—Å–æ–∫ –∑–∞—è–≤–æ–∫ (—Ç–æ–ª—å–∫–æ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤—ã—Ö –∑–∞–ø–∏—Å–µ–π) -->
  {% if not e %}
  <div class="mt-8">
    <h2 class="text-lg font-semibold mb-2">{{ t('pending_requests') }}</h2>
    {% if pending and pending|length %}
      <!-- –û–±—â–µ–µ –ø–æ–ª–µ –ø–∞—Ä–æ–ª—è –¥–ª—è –∞–¥–º–∏–Ω—Å–∫–∏—Ö –¥–µ–π—Å—Ç–≤–∏–π -->
      <div class="admin-password-block mb-4">
        <label class="label">{{ t('admin_password') }}</label>
        <div class="flex items-center gap-3">
          <input type="password" id="adminPassGlobal" class="input" placeholder="{{ t('admin_password') }}" autocomplete="off" style="width: 14rem;">
          <span class="opacity-70 text-sm">{{ t('need_password_for_action') }}</span>
        </div>
      </div>

      <div class="space-y-2" id="pendingList">
        {% for p in pending %}
          <div class="border rounded p-3 flex flex-col md:flex-row md:items-center md:justify-between gap-3">
            <div class="text-sm">
              <div><b>{{ p.city }}</b> ‚Äî {{ p.product }}</div>
              <div>{{ t('price') }}: {{ '%.0f'|format(p.price) }} | {{ t('trend') }}: {{ t(p.trend) }} | {{ t('percent') }}: {{ '%.0f'|format(p.percent) }}%</div>
              <div>{{ t('is_prod_city') }}: {{ t('yes') if p.is_production_city else t('no') }}</div>
              <div class="opacity-70">#{{ p.id }} ¬∑ {{ p.submitted_at.strftime('%Y-%m-%d %H:%M') if p.submitted_at else '' }}</div>
            </div>
            <div class="flex items-center gap-2">
              <form method="post" class="approveForm">
                <input type="hidden" name="_action" value="approve">
                <input type="hidden" name="pending_id" value="{{ p.id }}">
                <button class="btn btn-primary" type="submit">{{ t('approve') }}</button>
              </form>
              <form method="post" class="rejectForm">
                <input type="hidden" name="_action" value="reject">
                <input type="hidden" name="pending_id" value="{{ p.id }}">
                <button class="btn btn-outline" type="submit">{{ t('reject') }}</button>
              </form>
            </div>
          </div>
        {% endfor %}
      </div>

      <script>
        (function(){
          const passInput = document.getElementById('adminPassGlobal');
          document.querySelectorAll('#pendingList form').forEach(form => {
            form.addEventListener('submit', function(ev) {
              if (!passInput.value.trim()) {
                ev.preventDefault();
                alert('{{ t("need_password_for_action") }}');
                passInput.focus();
                return false;
              }
              const hiddenInput = document.createElement('input');
              hiddenInput.type = 'hidden';
              hiddenInput.name = 'admin_pass';
              hiddenInput.value = passInput.value;
              this.appendChild(hiddenInput);
            });
          });
        })();
      </script>
    {% else %}
      <p class="opacity-70">{{ t('no_data') }}</p>
    {% endif %}
  </div>
  {% endif %}

  <script>
    (function () {
      const form = document.getElementById('entryForm');

      // –û—á–∏—Å—Ç–∫–∞ –ø–æ –∫–Ω–æ–ø–∫–∞–º
      document.querySelectorAll('[data-clear]').forEach(btn => {
        btn.addEventListener('click', () => {
          const el = document.querySelector(btn.getAttribute('data-clear'));
          if (el) { el.value = ''; el.focus(); }
        });
      });

      // –°—Ç—Ä–µ–ª–∫–∏ —Ç—Ä–µ–Ω–¥–∞
      const trendSel = document.getElementById('trendSelect');
      document.querySelectorAll('[data-trend]').forEach(btn => {
        btn.addEventListener('click', () => {
          const val = btn.getAttribute('data-trend');
          if (trendSel) { trendSel.value = val; trendSel.dispatchEvent(new Event('change')); }
        });
      });

      // –¶–∏—Ñ—Ä–æ–≤–∞—è –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞
      document.querySelectorAll('[data-input]').forEach(btn => {
        btn.addEventListener('click', () => {
          const target = document.querySelector(btn.getAttribute('data-input'));
          const value = btn.getAttribute('data-value');
          if (target) {
            target.value += value;
            target.dispatchEvent(new Event('input', { bubbles: true }));
            target.focus();
          }
        });
      });

      // –ö–Ω–æ–ø–∫–∞ Backspace
      document.querySelectorAll('[data-backspace]').forEach(btn => {
        btn.addEventListener('click', () => {
          const target = document.querySelector(btn.getAttribute('data-backspace'));
          if (target && target.value.length > 0) {
            target.value = target.value.slice(0, -1);
            target.dispatchEvent(new Event('input', { bubbles: true }));
            target.focus();
          }
        });
      });

      // –§–æ–∫—É—Å –Ω–∞ –ø–æ–ª–µ —Ü–µ–Ω—ã –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
      const price = document.getElementById('priceField');
      if (price) price.focus();

      // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ –¥–≤–æ–π–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏
      let isSubmitting = false;
      if (form) {
        form.addEventListener('submit', function(event) {
          if (isSubmitting) {
            event.preventDefault();
            return false;
          }
          isSubmitting = true;
          const submitBtn = document.getElementById('submitBtn');
          if (submitBtn) {
            submitBtn.disabled = true;
            submitBtn.textContent = '{{ t("saving") if t("saving") else "Saving..." }}';
          }
        });
      }
    })();
  </script>

  <!-- –£—Å–∏–ª–µ–Ω–∏–µ datalist: —Å–Ω–∞—á–∞–ª–∞ –≤–∞—Ä–∏–∞–Ω—Ç—ã, –Ω–∞—á–∏–Ω–∞—é—â–∏–µ—Å—è —Å –≤–≤–µ–¥—ë–Ω–Ω–æ–≥–æ –ø—Ä–µ—Ñ–∏–∫—Å–∞ -->
  <script>
    (function enhanceDatalist(){
      function prioritizePrefix(inputId, listId){
        const input = document.getElementById(inputId);
        const list  = document.getElementById(listId);
        if(!input || !list) return;
        const original = Array.from(list.options).map(o => o.value);
        input.addEventListener('input', () => {
          const q = (input.value || '').toLowerCase();
          const starts = [], contains = [];
          for(const v of original){
            const lv = v.toLowerCase();
            if(q && lv.startsWith(q)) starts.push(v);
            else if(!q || lv.includes(q)) contains.push(v);
          }
          list.innerHTML = '';
          [...new Set([...starts, ...contains])].slice(0, 200).forEach(v=>{
            const opt = document.createElement('option');
            opt.value = v;
            list.appendChild(opt);
          });
        });
      }
      prioritizePrefix('cityField', 'citiesList');
      prioritizePrefix('productField', 'productsList');
    })();
  </script>
</section>
{% endblock %}
