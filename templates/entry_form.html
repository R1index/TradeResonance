{% extends "base.html" %}
{% block content %}
<section class="card p-4">
  <h1 class="text-xl font-semibold mb-3">{{ title }}</h1>

  <form method="post" class="grid grid-cols-1 md:grid-cols-4 gap-3" id="entryForm">
    <input type="hidden" name="next" value="{{ next_url or request.referrer }}">
    <input type="hidden" name="_action" value="submit_request">

    <!-- Город -->
    <div class="md:col-span-2">
      <label class="label">{{ t('city') }}</label>
      <input
        name="city"
        class="input"
        list="citiesList"
        value="{{ request.form.get('city','') or request.args.get('city','') }}"
        required>
      <datalist id="citiesList">
        {% for c in cities_list %}<option value="{{ c }}">{% endfor %}
      </datalist>
    </div>

    <!-- Товар -->
    <div class="md:col-span-2">
      <label class="label">{{ t('product') }}</label>
      <input
        name="product"
        class="input"
        list="productsList"
        value="{{ request.form.get('product','') }}"
        required>
      <datalist id="productsList">
        {% for p in products_list %}<option value="{{ p }}">{% endfor %}
      </datalist>
    </div>

    <!-- Цена + Очистить -->
    <div>
      <div class="flex items-center justify-between">
        <label class="label">{{ t('price') }}</label>
        <button type="button" class="btn btn-outline px-2 py-1 text-xs" data-clear="#priceField">
          {{ 'Clear' if lang=='en' else 'Очистить' }}
        </button>
      </div>
      <input id="priceField" type="number" step="1" name="price" class="input"
             value="{{ request.form.get('price','') }}" required>
    </div>

    <!-- Процент + Очистить -->
    <div>
      <div class="flex items-center justify-between">
        <label class="label">{{ t('percent') }} %</label>
        <button type="button" class="btn btn-outline px-2 py-1 text-xs" data-clear="#percentField">
          {{ 'Clear' if lang=='en' else 'Очистить' }}
        </button>
      </div>
      <input id="percentField" type="number" step="1" name="percent" class="input"
             value="{{ request.form.get('percent','0') }}" required>
    </div>

    <!-- Тренд + стрелки -->
    <div>
      <div class="flex items-center justify-between">
        <label class="label">{{ t('trend') }}</label>
        <div class="flex gap-1">
          <button type="button" class="btn btn-outline px-2 py-1 text-xs" data-trend="up" title="{{ t('up') }}">▲</button>
          <button type="button" class="btn btn-outline px-2 py-1 text-xs" data-trend="down" title="{{ t('down') }}">▼</button>
        </div>
      </div>
      <select id="trendSelect" name="trend" class="select" required>
        {% for opt in ['up','down'] %}
        <option value="{{ opt }}" {% if request.form.get('trend','up')==opt %}selected{% endif %}>
          {{ t(opt) }}
        </option>
        {% endfor %}
      </select>
    </div>

    <!-- Производственный город -->
    <div class="flex items-end">
      <label class="inline-flex items-center gap-2">
        <input type="checkbox" class="h-4 w-4" name="is_production_city"
               {% if request.form.get('is_production_city') %}checked{% endif %}>
        <span class="label">{{ t('is_prod_city') }}</span>
      </label>
    </div>

    <!-- Кнопки -->
    <div class="md:col-span-4 flex gap-2 pt-2">
      <button class="btn btn-primary" id="submitBtn" type="submit">{{ t('submit') }}</button>
      <a class="btn btn-outline" href="{{ next_url or request.referrer or url_for('index', lang=lang) }}">← {{ t('back') }}</a>
    </div>
  </form>

  <!-- Список заявок (для админа, одно поле пароля) -->
  <div class="mt-8">
    <h2 class="text-lg font-semibold mb-2">{{ t('pending_requests') }}</h2>
    {% if pending and pending|length %}
      <div class="space-y-2" id="pendingList">
        {% for p in pending %}
          <div class="border rounded p-3 flex flex-col md:flex-row md:items-center md:justify-between gap-3">
            <div class="text-sm">
              <div><b>{{ p.city }}</b> — {{ p.product }}</div>
              <div>{{ t('price') }}: {{ '%.0f'|format(p.price) }} | {{ t('trend') }}: {{ t(p.trend) }} | {{ t('percent') }}: {{ '%.0f'|format(p.percent) }}%</div>
              <div>{{ t('is_prod_city') }}: {{ t('yes') if p.is_production_city else t('no') }}</div>
              <div class="opacity-70">#{{ p.id }} · {{ p.submitted_at }}</div>
            </div>
            <div class="flex items-center gap-2">
              <form method="post" class="approveForm flex items-center gap-2">
                <input type="hidden" name="_action" value="approve">
                <input type="hidden" name="pending_id" value="{{ p.id }}">
                <button class="btn btn-primary" type="submit">{{ t('approve') }}</button>
              </form>
              <form method="post" class="rejectForm flex items-center gap-2">
                <input type="hidden" name="_action" value="reject">
                <input type="hidden" name="pending_id" value="{{ p.id }}">
                <button class="btn btn-outline" type="submit">{{ t('reject') }}</button>
              </form>
            </div>
          </div>
        {% endfor %}
      </div>

      <!-- Общее поле пароля -->
      <div class="mt-4 flex items-center gap-3">
        <input type="password" id="adminPassGlobal" class="input" placeholder="{{ t('admin_password') }}" autocomplete="off" style="width: 14rem;">
        <span class="opacity-70 text-sm">{{ t('need_password_for_action') }}</span>
      </div>

      <script>
        (function(){
          const passInput = document.getElementById('adminPassGlobal');
          document.querySelectorAll('#pendingList form').forEach(f => {
            f.addEventListener('submit', ev => {
              if (!passInput.value.trim()) {
                ev.preventDefault();
                alert('{{ t("need_password_for_action") }}');
                passInput.focus();
                return false;
              }
              // добавляем скрытое поле с паролем перед отправкой
              const hidden = document.createElement('input');
              hidden.type = 'hidden';
              hidden.name = 'admin_pass';
              hidden.value = passInput.value;
              f.appendChild(hidden);
            });
          });
        })();
      </script>
    {% else %}
      <p class="opacity-70">{{ t('no_data') }}</p>
    {% endif %}
  </div>
        {% endfor %}
      </div>
    {% else %}
      <p class="opacity-70">{{ t('no_data') }}</p>
    {% endif %}
  </div>

  <script>
    (function () {
      const form = document.getElementById('entryForm');

      // Очистка по кнопкам
      document.querySelectorAll('[data-clear]').forEach(btn => {
        btn.addEventListener('click', () => {
          const el = document.querySelector(btn.getAttribute('data-clear'));
          if (el) { el.value = ''; el.focus(); }
        });
      });

      // Стрелки тренда
      const trendSel = document.getElementById('trendSelect');
      document.querySelectorAll('[data-trend]').forEach(btn => {
        btn.addEventListener('click', () => {
          const val = btn.getAttribute('data-trend');
          if (trendSel) { trendSel.value = val; trendSel.dispatchEvent(new Event('change')); }
        });
      });

      const price = document.getElementById('priceField');
      if (price) price.focus();
    })();
  </script>
</section>
{% endblock %}
