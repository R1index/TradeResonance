{% extends "base.html" %}
{% block content %}
<section class="card p-4">
  <h1 class="text-xl font-semibold mb-3">{{ title }}</h1>

  <form method="post" class="grid grid-cols-1 md:grid-cols-4 gap-3" id="entryForm">
    <input type="hidden" name="next" value="{{ next_url or request.referrer }}">

    <!-- Город -->
    <div class="md:col-span-2">
      <label class="label">{{ t('city') }}</label>
      <input
        name="city"
        class="input"
        list="citiesList"
        value="{% if e %}{{ e.city }}{% else %}{{ request.form.get('city','') or request.args.get('city','') }}{% endif %}"
        {% if e %}disabled{% else %}required{% endif %}>
      <datalist id="citiesList">
        {% for c in cities_list %}<option value="{{ c }}">{% endfor %}
      </datalist>
    </div>

    <!-- Товар -->
    <div class="md:col-span-2">
      <label class="label">{{ t('product') }}</label>
      <input
        name="product"
        class="input"
        list="productsList"
        value="{% if e %}{{ e.product }}{% else %}{{ request.form.get('product','') }}{% endif %}"
        {% if e %}disabled{% else %}required{% endif %}>
      <datalist id="productsList">
        {% for p in products_list %}<option value="{{ p }}">{% endfor %}
      </datalist>
    </div>

    <!-- Цена + Очистить -->
    <div>
      <div class="flex items-center justify-between">
        <label class="label">{{ t('price') }}</label>
        <button type="button" class="btn btn-outline px-2 py-1 text-xs" data-clear="#priceField">
          {{ 'Clear' if lang=='en' else 'Очистить' }}
        </button>
      </div>
      <input id="priceField" type="number" step="1" name="price" class="input"
             value="{% if e %}{{ e.price }}{% else %}{{ request.form.get('price','') }}{% endif %}" required>
    </div>

    <!-- Процент + Очистить -->
    <div>
      <div class="flex items-center justify-between">
        <label class="label">{{ t('percent') }} %</label>
        <button type="button" class="btn btn-outline px-2 py-1 text-xs" data-clear="#percentField">
          {{ 'Clear' if lang=='en' else 'Очистить' }}
        </button>
      </div>
      <input id="percentField" type="number" step="1" name="percent" class="input"
             value="{% if e %}{{ e.percent|int }}{% else %}{{ request.form.get('percent','0') }}{% endif %}" required>
    </div>

    <!-- Тренд + стрелки -->
    <div>
      <div class="flex items-center justify-between">
        <label class="label">{{ t('trend') }}</label>
        <div class="flex gap-1">
          <button type="button" class="btn btn-outline px-2 py-1 text-xs" data-trend="up" title="{{ t('up') }}">▲</button>
          <button type="button" class="btn btn-outline px-2 py-1 text-xs" data-trend="down" title="{{ t('down') }}">▼</button>
        </div>
      </div>
      <select id="trendSelect" name="trend" class="select" required>
        {% for opt in ['up','down'] %}
        <option value="{{ opt }}"
          {% if e and e.trend==opt %}selected{% elif not e and request.form.get('trend','up')==opt %}selected{% endif %}>
          {{ t(opt) }}
        </option>
        {% endfor %}
      </select>
    </div>

    <!-- Производственный город -->
    <div class="flex items-end">
      <label class="inline-flex items-center gap-2">
        {% if not e %}
          <input type="checkbox" class="h-4 w-4" name="is_production_city"
                 {% if request.form.get('is_production_city') or (e and e.is_production_city) %}checked{% endif %}>
        {% else %}
          <input type="checkbox" class="h-4 w-4" {% if e.is_production_city %}checked{% endif %} disabled>
        {% endif %}
        <span class="label">{{ t('is_prod_city') }}</span>
      </label>
    </div>

    <!-- Пароль (только при создании) -->
    {% if not e %}
    <div>
      <label class="label">{{ t('password') }}</label>
      <input type="password" name="admin_pass" class="input" autocomplete="off"
             placeholder="{{ t('password') }}" required
             value="{{ request.form.get('admin_pass','') or request.args.get('admin_pass','') }}">
    </div>
    {% endif %}

    <!-- Кнопки -->
    <div class="md:col-span-4 flex gap-2 pt-2">
      <button class="btn btn-primary" id="submitBtn" type="submit">{{ t('save') if e else t('create') }}</button>
      <a class="btn btn-outline" href="{{ next_url or request.referrer or url_for('index', lang=lang) }}">← {{ t('back') }}</a>
    </div>
  </form>

  <script>
    (function () {
      const form = document.getElementById('entryForm');
      const isEdit = {{ 'true' if e else 'false' }};
      const cityInput = form.querySelector('input[name="city"]');
      const passInput = form.querySelector('input[name="admin_pass"]');

      // локальные ключи (переживаем редирект)
      const K_CITY = 'th_city';
      const K_PASS = 'th_admin';

      // Восстанавливаем (если это создание и поля пустые)
      if (!isEdit) {
        if (cityInput && !cityInput.value) {
          const v = sessionStorage.getItem(K_CITY);
          if (v) cityInput.value = v;
        }
        if (passInput && !passInput.value) {
          const v = sessionStorage.getItem(K_PASS);
          if (v) passInput.value = v;
        }
      }

      // Сохраняем перед submit (только создание)
      form.addEventListener('submit', () => {
        if (!isEdit) {
          if (cityInput) sessionStorage.setItem(K_CITY, cityInput.value || '');
          if (passInput) sessionStorage.setItem(K_PASS, passInput.value || '');
        }
      });

      // Очистка по кнопкам
      document.querySelectorAll('[data-clear]').forEach(btn => {
        btn.addEventListener('click', () => {
          const el = document.querySelector(btn.getAttribute('data-clear'));
          if (el) { el.value = ''; el.focus(); }
        });
      });

      // Стрелки тренда
      const trendSel = document.getElementById('trendSelect');
      document.querySelectorAll('[data-trend]').forEach(btn => {
        btn.addEventListener('click', () => {
          const val = btn.getAttribute('data-trend');
          if (trendSel) { trendSel.value = val; trendSel.dispatchEvent(new Event('change')); }
        });
      });

      // Если пришли после успешного создания — очистим всё, кроме City и Password.
      // Сервер после сохранения делает PRG-редирект обратно на /entries/new.
      // Факт «успеха» распознаём по query-параметру success=1 (задать в контроллере) ИЛИ по флешу.
      const flashHolder = document.querySelector('[data-flash]');
      const flashDataRaw = flashHolder ? flashHolder.getAttribute('data-flash') : '';
      let isSuccess = false;
      try {
        const f = flashDataRaw ? JSON.parse(flashDataRaw) : null;
        isSuccess = !!(f && f.message && (f.message.includes('{{ t("saved") }}') || f.message.includes('{{ t("updated") }}')));
      } catch {}

      if (!isEdit && isSuccess) {
        // очистим все поля формы…
        form.reset();
        // …кроме города и пароля (берём из sessionStorage)
        if (cityInput) cityInput.value = sessionStorage.getItem(K_CITY) || cityInput.value;
        if (passInput) passInput.value = sessionStorage.getItem(K_PASS) || passInput.value;
        // и вернём тренд к up
        if (trendSel) trendSel.value = 'up';
        // фокус на цену
        const price = document.getElementById('priceField');
        if (price) price.focus();
      }
    })();
  </script>
</section>
{% endblock %}
