{% extends "base.html" %}
{% block content %}
<section class="card p-4">
  <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-4">
    <div>
      <h1 class="text-xl font-semibold">{{ t('nav_prices') }}</h1>
      {% if totals %}
      <div class="mt-2 grid grid-cols-1 sm:grid-cols-3 gap-2 text-sm text-[var(--muted)]">
        <div class="summary-chip">
          <span class="summary-label">{{ 'Entries' if lang=='en' else '–ó–∞–ø–∏—Å–µ–π' }}</span>
          <span class="summary-value">{{ totals.entries }}</span>
        </div>
        <div class="summary-chip">
          <span class="summary-label">{{ t('nav_cities') }}</span>
          <span class="summary-value">{{ totals.cities }}</span>
        </div>
        <div class="summary-chip">
          <span class="summary-label">{{ t('product') }}</span>
          <span class="summary-value">{{ totals.products }}</span>
        </div>
      </div>
      {% endif %}
    </div>
    <div class="flex flex-wrap gap-2">
      <a class="btn btn-outline"
         href="{{ url_for('export_csv') }}?city={{ q_city }}&product={{ q_product }}&trend={{ q_trend }}
         &price_min={{ q_price_min }}&price_max={{ q_price_max }}
         &percent_min={{ q_percent_min }}&percent_max={{ q_percent_max }}
         &prod={{ q_prod }}&has_prod={% if q_has_prod %}1{% endif %}&sort={{ q_sort }}&lang={{ lang }}">
        Export CSV
      </a>
      <a href="{{ url_for('new_entry', lang=lang) }}" class="btn btn-primary">{{ t('nav_add') }}</a>
    </div>
  </div>

  <!-- –§–ò–õ–¨–¢–†–´ -->
  {% set filters_active = q_city or q_product or q_trend or q_price_min is not none or q_price_max is not none or q_percent_min is not none or q_percent_max is not none or q_prod != 'any' or q_has_prod or q_sort != 'updated_desc' or per_page != 15 %}
  <details class="filters-card" {% if filters_active %}open{% endif %}>
    <summary class="filters-summary">{{ t('filters') }}</summary>
    <form class="filters-grid" method="get" id="filtersForm">
      <input type="hidden" name="tab" value="prices">

      <div>
        <label class="label">{{ t('city') }}</label>
        <input class="input" name="city" placeholder="{{ t('city') }}" value="{{ q_city }}" autocomplete="off" data-city-autocomplete>
      </div>

      <div>
        <label class="label">{{ t('product') }}</label>
        <input class="input" name="product" placeholder="{{ t('product') }}" value="{{ q_product }}" data-product-autocomplete autocomplete="off">
      </div>

      <div>
        <label class="label">{{ t('trend') }}</label>
        <select class="select" name="trend">
          <option value="">{{ t('trend') }}</option>
          <option value="up"   {% if q_trend=='up' %}selected{% endif %}>{{ t('up') }}</option>
          <option value="down" {% if q_trend=='down' %}selected{% endif %}>{{ t('down') }}</option>
        </select>
      </div>

      <div>
        <label class="label">{{ t('price') }} ‚â•</label>
        <input class="input" type="number" step="1" name="price_min" value="{{ q_price_min or '' }}">
      </div>
      <div>
        <label class="label">{{ t('price') }} ‚â§</label>
        <input class="input" type="number" step="1" name="price_max" value="{{ q_price_max or '' }}">
      </div>

      <div>
        <label class="label">{{ t('percent') }}% ‚â•</label>
        <input class="input" type="number" step="1" name="percent_min" value="{{ q_percent_min or '' }}">
      </div>
      <div>
        <label class="label">{{ t('percent') }}% ‚â§</label>
        <input class="input" type="number" step="1" name="percent_max" value="{{ q_percent_max or '' }}">
      </div>

      <div>
        <label class="label">{{ t('is_prod_city') }}</label>
        <select class="select" name="prod">
          <option value="any" {% if q_prod=='any' %}selected{% endif %}>‚Äî</option>
          <option value="yes" {% if q_prod=='yes' %}selected{% endif %}>{{ t('yes') }}</option>
          <option value="no"  {% if q_prod=='no'  %}selected{% endif %}>{{ t('no') }}</option>
        </select>
      </div>

      <div>
        <label class="label">{{ t('production_filter') }}</label>
        <label class="inline-flex items-center gap-2 text-sm text-[var(--muted)]">
          <input type="checkbox" class="h-4 w-4" name="has_prod" value="1" {% if q_has_prod %}checked{% endif %}>
          <span class="text-[var(--text)]">{{ t('production_filter_only') }}</span>
        </label>
      </div>

      <div>
        <label class="label">Sort</label>
        <select class="select" name="sort">
          <option value="updated_desc" {% if q_sort=='updated_desc' %}selected{% endif %}>Updated ‚Üì</option>
          <option value="updated_asc"  {% if q_sort=='updated_asc'  %}selected{% endif %}>Updated ‚Üë</option>
          <option value="price_desc"   {% if q_sort=='price_desc'   %}selected{% endif %}>Price ‚Üì</option>
          <option value="price_asc"    {% if q_sort=='price_asc'    %}selected{% endif %}>Price ‚Üë</option>
          <option value="percent_desc" {% if q_sort=='percent_desc' %}selected{% endif %}>Percent ‚Üì</option>
          <option value="percent_asc"  {% if q_sort=='percent_asc'  %}selected{% endif %}>Percent ‚Üë</option>
        </select>
      </div>

    <!-- –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: –≤—ã–±–æ—Ä —Ä–∞–∑–º–µ—Ä–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã -->
      <div>
        <label class="label">Per page</label>
        <input class="input" type="number" min="1" max="500" name="per_page" value="{{ per_page }}">
      </div>

      <div class="md:col-span-6 flex gap-2">
        <button class="btn btn-primary" type="submit">{{ t('filters') }}</button>
        <a class="btn btn-outline" href="{{ url_for('index', tab='prices', lang=lang) }}">Reset</a>
      </div>
    </form>
  </details>

  {% if not entries %}
    <p class="text-zinc-500">{{ t('no_data') }}</p>
  {% else %}
  <div class="overflow-x-auto">
    <table class="min-w-full table-card stacked-table" id="pricesTable">
      <thead class="text-left text-sm text-zinc-600 dark:text-zinc-400">
        <tr>
          <th class="py-2">ID</th>
          <th class="py-2">{{ t('city') }}</th>
          <th class="py-2">{{ t('product') }}</th>
          <th class="py-2">{{ t('price') }} / {{ t('trend') }} / {{ t('percent') }}%</th>
          <th class="py-2">{{ 'Updated' if lang=='en' else '–û–±–Ω–æ–≤–ª–µ–Ω–æ' }}</th>
          <th class="py-2">{{ t('actions') }}</th>
        </tr>
      </thead>

      <tbody class="text-sm">
        {% for e in entries %}
        <!-- –æ—Å–Ω–æ–≤–Ω–∞—è —Å—Ç—Ä–æ–∫–∞ - –í–°–Ø –°–¢–†–û–ö–ê –ö–õ–ò–ö–ê–ë–ï–õ–¨–ù–ê -->
        <tr class="border-b border-zinc-200 dark:border-zinc-800 clickable-row" 
            data-row="{{ e.id }}" 
            data-quick-edit="{{ e.id }}" 
            tabindex="0"
            aria-label="Quick edit {{ e.city }} - {{ e.product }}">
          <td class="py-2" data-label="ID">{{ e.id }}</td>
          <td class="py-2" data-label="{{ t('city') }}">
            <span class="inline-flex items-center gap-1">
              {% if e.is_production_city %}
                <span class="city-emoji" role="img" aria-label="{{ t('is_prod_city') }}">üè≠</span>
              {% endif %}
              <span>{{ e.city }}</span>
            </span>
          </td>
          <td class="py-2" data-label="{{ t('product') }}">
            <div class="flex items-center gap-3">
              <div class="product-thumb product-thumb--table">
                {% if e.image_path %}
                  <img src="{{ url_for('static', filename=e.image_path) }}" alt="{{ e.product }}">
                {% else %}
                  <span>üì¶</span>
                {% endif %}
              </div>
              <span>{{ e.product }}</span>
            </div>
          </td>
          <td class="py-2" data-col="pricing" data-label="{{ t('price') }} / {{ t('trend') }} / {{ t('percent') }}%">
            <div class="pricing-group">
              <div class="pricing-item">
                <span class="pricing-value" data-field="price">{{ '%.0f' % e.price }}</span>
                <span class="pricing-label">{{ t('price') }}</span>
              </div>
              <div class="pricing-divider" aria-hidden="true"></div>
              <div class="pricing-item">
                <span class="pricing-badge" data-field="trend">
                  {% if e.trend=='up' %}
                    <span class="badge badge-green">{{ t('up') }}</span>
                  {% else %}
                    <span class="badge badge-red">{{ t('down') }}</span>
                  {% endif %}
                </span>
                <span class="pricing-label">{{ t('trend') }}</span>
              </div>
              <div class="pricing-divider" aria-hidden="true"></div>
              <div class="pricing-item">
                <span class="pricing-value percent" data-field="percent">{{ '%.0f' % e.percent }}%</span>
                <span class="pricing-label">{{ t('percent') }}</span>
              </div>
            </div>
          </td>

          {# –ü–∏—à–µ–º UTC-ISO —Å 'Z'. –ü—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ—Ç—Å—è, —á—Ç–æ updated_at —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ UTC. #}
          <td class="py-2" data-label="{{ 'Updated' if lang=='en' else '–û–±–Ω–æ–≤–ª–µ–Ω–æ' }}" data-col="updated"
              data-updated-iso="{{ (e.updated_at or e.created_at).strftime('%Y-%m-%dT%H:%M:%SZ') }}">
          </td>

          <td class="py-2" data-label="{{ t('actions') }}" data-actions>
            <a class="btn btn-outline" href="{{ url_for('edit_entry', entry_id=e.id, lang=lang) }}">{{ t('edit') }}</a>
          </td>
        </tr>

        <!-- —Å—Ç—Ä–æ–∫–∞-—Ä–µ–¥–∞–∫—Ç–æ—Ä -->
        <tr class="hidden bg-[var(--bg)]" id="editor-{{ e.id }}" data-editor-row="true">
          <td colspan="6" class="py-3" data-label="">
            <form class="flex flex-wrap items-end gap-3 quick-form"
                  method="post"
                  action="{{ url_for('edit_entry', entry_id=e.id, lang=lang) }}"
                  data-price0="{{ '%.6f' % e.price }}"
                  data-percent0="{{ '%.6f' % e.percent }}">
              <input type="hidden" name="next" value="{{ request.full_path }}">

              <!-- –¶–ï–ù–ê: —Ç–æ–ª—å–∫–æ –ø—Ä–æ—Å–º–æ—Ç—Ä (readonly), –Ω–æ —É—Ö–æ–¥–∏—Ç –≤ POST -->
              <div>
                <label class="label">{{ t('price') }}</label>
                <input class="input w-32" type="number" step="1" name="price"
                       value="{{ '%.0f' % e.price }}" readonly aria-readonly="true"
                       title="{{ 'Auto-calculated from %' if lang=='en' else '–ê–≤—Ç–æ–ø–æ–¥—Å—á–µ—Ç –æ—Ç %' }}">
              </div>

              <!-- –¢–†–ï–ù–î: –∫–Ω–æ–ø–∫–∏ UP/DOWN + —Å–∫—Ä—ã—Ç—ã–π select –¥–ª—è POST -->
              <div class="flex flex-col gap-2">
                <label class="label">{{ t('trend') }}</label>
                <div class="flex items-center gap-2">
                  <button type="button" class="btn btn-trend btn-up" data-trend="up" aria-pressed="false">
                    ‚ñ≤ {{ t('up') }}
                  </button>
                  <button type="button" class="btn btn-trend btn-down" data-trend="down" aria-pressed="false">
                    ‚ñº {{ t('down') }}
                  </button>
                </div>
                <select class="select w-32 sr-only" name="trend" aria-hidden="true" tabindex="-1">
                  <option value="up"   {% if e.trend=='up' %}selected{% endif %}>{{ t('up') }}</option>
                  <option value="down" {% if e.trend=='down' %}selected{% endif %}>{{ t('down') }}</option>
                </select>
              </div>

              <!-- –ü–†–û–¶–ï–ù–¢: —á–∏—Å–ª–æ + –∫–Ω–æ–ø–∫–∏ -/+ + –ø–æ–ª–∑—É–Ω–æ–∫ -->
              <div class="md:col-span-2">
                <label class="label">{{ t('percent') }} %</label>
                <div class="flex items-center gap-3 flex-wrap">
                  <button type="button" class="btn btn-icon" data-delta="-1" aria-label="Minus 1%">‚àí</button>
                  <input class="input w-24" type="number" step="1" min="0" max="200"
                         name="percent" id="percent-{{ e.id }}" value="{{ '%.0f' % e.percent }}">
                  <input type="range" class="w-56" min="0" max="200" step="1"
                         value="{{ '%.0f' % e.percent }}" aria-label="Percent slider"
                         data-bind-to="percent-{{ e.id }}">
                  <button type="button" class="btn btn-icon" data-delta="1" aria-label="Plus 1%">+</button>
                  <span class="text-xs text-[var(--muted)]" data-percent-label="{{ e.id }}">
                    {{ '%.0f' % e.percent }}%
                  </span>
                  <span class="text-[11px] text-[var(--muted)]">
                    {{ 'Shift = step 5' if lang=='en' else 'Shift = —à–∞–≥ 5' }}
                  </span>
                </div>
              </div>

              <div class="flex gap-2">
                <button class="btn btn-primary" type="submit">{{ t('save') }}</button>
                <button class="btn btn-outline" type="button" data-close="{{ e.id }}">√ó</button>
              </div>

              <div class="text-xs text-[var(--muted)]">
                {{ t('city') }}: <strong>{{ e.city }}</strong> ‚Ä¢ {{ t('product') }}: <strong>{{ e.product }}</strong>
              </div>
            </form>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- –ü–ê–ì–ò–ù–ê–¶–ò–Ø -->
  {% if pagination.pages > 1 %}
  <nav class="mt-4 flex flex-wrap items-center justify-center gap-2" aria-label="Pagination">
    {% if pagination.page > 1 %}
      <a class="btn btn-outline px-3" href="{{ url_for('index', tab='prices', lang=lang,
            city=q_city, product=q_product, trend=q_trend,
            price_min=q_price_min, price_max=q_price_max,
            percent_min=q_percent_min, percent_max=q_percent_max,
            prod=q_prod, sort=q_sort, per_page=per_page, page=1) }}">&laquo; First</a>
    {% else %}
      <span class="btn btn-disabled px-3">&laquo; First</span>
    {% endif %}

    {% if pagination.has_prev %}
      <a class="btn btn-outline px-3" href="{{ url_for('index', tab='prices', lang=lang,
            city=q_city, product=q_product, trend=q_trend,
            price_min=q_price_min, price_max=q_price_max,
            percent_min=q_percent_min, percent_max=q_percent_max,
            prod=q_prod, sort=q_sort, per_page=per_page, page=pagination.prev_num) }}">&lsaquo; Prev</a>
    {% else %}
      <span class="btn btn-disabled px-3">&lsaquo; Prev</span>
    {% endif %}

    {% for p in page_numbers %}
      {% if p == pagination.page %}
        <span class="btn btn-primary px-3">{{ p }}</span>
      {% else %}
        <a class="btn btn-outline px-3" href="{{ url_for('index', tab='prices', lang=lang,
              city=q_city, product=q_product, trend=q_trend,
              price_min=q_price_min, price_max=q_price_max,
              percent_min=q_percent_min, percent_max=q_percent_max,
              prod=q_prod, sort=q_sort, per_page=per_page, page=p) }}">{{ p }}</a>
      {% endif %}
    {% endfor %}

    {% if pagination.has_next %}
      <a class="btn btn-outline px-3" href="{{ url_for('index', tab='prices', lang=lang,
            city=q_city, product=q_product, trend=q_trend,
            price_min=q_price_min, price_max=q_price_max,
            percent_min=q_percent_min, percent_max=q_percent_max,
            prod=q_prod, sort=q_sort, per_page=per_page, page=pagination.next_num) }}">Next &rsaquo;</a>
    {% else %}
      <span class="btn btn-disabled px-3">Next &rsaquo;</span>
    {% endif %}

    {% if pagination.page < pagination.pages %}
      <a class="btn btn-outline px-3" href="{{ url_for('index', tab='prices', lang=lang,
            city=q_city, product=q_product, trend=q_trend,
            price_min=q_price_min, price_max=q_price_max,
            percent_min=q_percent_min, percent_max=q_percent_max,
            prod=q_prod, sort=q_sort, per_page=per_page, page=pagination.pages) }}">Last &raquo;</a>
    {% else %}
      <span class="btn btn-disabled px-3">Last &raquo;</span>
    {% endif %}
  </nav>
  {% endif %}
  {% endif %}
</section>

<script>
(function(){
  // –°–±—Ä–æ—Å —Å—Ç—Ä–∞–Ω–∏—Ü—ã –Ω–∞ 1 –ø—Ä–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–∏ —Ñ–∏–ª—å—Ç—Ä–æ–≤
  const filtersForm = document.getElementById('filtersForm');
  if (filtersForm) {
    filtersForm.addEventListener('submit', () => {
      const pageInput = document.createElement('input');
      pageInput.type = 'hidden';
      pageInput.name = 'page';
      pageInput.value = '1';
      filtersForm.appendChild(pageInput);
    });
  }

  const table = document.getElementById('pricesTable');
  if (!table) return;

  let openedId = null;

  // –∫–ª–∏–∫ –ø–æ –≤—Å–µ–π —Å—Ç—Ä–æ–∫–µ
  table.addEventListener('click', (e) => {
    const row = e.target.closest('.clickable-row');
    if (!row) return;
    if (e.target.closest('a') || e.target.closest('button')) return;
    toggleEditor(row.getAttribute('data-quick-edit'));
  });

  // —Ä–∞—Å–∫—Ä—ã—Ç–∏–µ –ø–æ Enter / Space –¥–ª—è –≤—Å–µ–π —Å—Ç—Ä–æ–∫–∏
  table.addEventListener('keydown', (e) => {
    const row = e.target.closest('.clickable-row');
    if (!row) return;
    if (e.key === 'Enter' || e.key === ' ') {
      e.preventDefault();
      toggleEditor(row.getAttribute('data-quick-edit'));
    }
  });

  // –∑–∞–∫—Ä—ã—Ç–∏–µ —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞
  table.addEventListener('click', (e) => {
    const btn = e.target.closest('button[data-close]');
    if (!btn) return;
    toggleEditor(btn.getAttribute('data-close'), false);
  });

  function toggleEditor(id, forceOpen){
    const row = document.getElementById('editor-'+id);
    if (!row) return;

    if (openedId && openedId !== id){
      const prev = document.getElementById('editor-'+openedId);
      if (prev) prev.classList.add('hidden');
      openedId = null;
    }

    const willOpen = (forceOpen !== undefined) ? forceOpen : row.classList.contains('hidden');
    row.classList.toggle('hidden', !willOpen);
    openedId = willOpen ? id : null;

    if (willOpen){
      const firstInput = row.querySelector('input[name="percent"], input[name="price"]');
      if (firstInput) firstInput.focus();
      const form = row.querySelector('form.quick-form');
      if (form) syncTrendButtons(form);
    }
  }

  // === –û—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ–µ –≤—Ä–µ–º—è –æ—Ç UTC ===
  function relLabel(dateIso, lang){
    if (!dateIso) return '';
    // dateIso –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Å 'Z' => UTC
    const now = new Date(); // —ç—Ç–æ "—Ç–µ–∫—É—â–∏–π –º–æ–º–µ–Ω—Ç" –≤ UTC –¥–ª—è toISOString; —Ä–∞–∑–Ω–æ—Å—Ç—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞ –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç TZ
    const d = new Date(dateIso);
    if (isNaN(d.getTime())) return '';
    let sec = Math.max(0, Math.floor((now - d) / 1000));

    const en = { just:'just now', min:'min ago', hour:'h ago', day:'d ago' };
    const ru = { just:'—Ç–æ–ª—å–∫–æ —á—Ç–æ', min1:'–º–∏–Ω –Ω–∞–∑–∞–¥', hour1:'—á –Ω–∞–∑–∞–¥', day1:'–¥–Ω –Ω–∞–∑–∞–¥' };
    const isEn = (lang === 'en');

    if (sec < 45) return isEn ? en.just : ru.just;
    const min = Math.floor(sec/60);
    if (min < 60) return isEn ? `${min} ${en.min}` : `${min} ${ru.min1}`;
    const hr = Math.floor(min/60);
    if (hr < 24) return isEn ? `${hr} ${en.hour}` : `${hr} ${ru.hour1}`;
    const day = Math.floor(hr/24);
    return isEn ? `${day} ${en.day}` : `${day} ${ru.day1}`;
  }

  function renderAllRelative(){
    const lang = "{{ lang }}";
    document.querySelectorAll('[data-updated-iso]').forEach(cell => {
      cell.textContent = relLabel(cell.getAttribute('data-updated-iso'), lang);
    });
  }
  renderAllRelative();
  setInterval(renderAllRelative, 60 * 1000);

  // === –ü–µ—Ä–µ—Å—á—ë—Ç —Ü–µ–Ω—ã (0..200) + —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–ª–∞–π–¥–µ—Ä ===
  function calcBaseFromForm(form){
    const p0 = Number(form.dataset.price0 || form.price?.defaultValue || form.price?.value || 0);
    const perc0Raw = Number(form.dataset.percent0 || form.percent?.defaultValue || form.percent?.value || 100);
    const perc0 = (isFinite(perc0Raw) && perc0Raw > 0) ? perc0Raw : 100;
    return p0 / (perc0/100);
  }
  function clampPercent(v){
    if (!isFinite(v)) return 0;
    if (v < 0) return 0;
    if (v > 200) return 200;
    return Math.round(v);
  }
  function applyPercent(form, perc, source){
    const percentInput = form.querySelector('input[name="percent"]');
    if (percentInput) percentInput.value = perc;
    const slider = percentInput ? form.querySelector(`input[type="range"][data-bind-to="${percentInput.id}"]`) : null;
    if (slider && source !== 'slider') slider.value = perc;
    let key = null;
    if (percentInput && percentInput.id) {
      const parts = percentInput.id.split('percent-');
      if (parts.length === 2) key = parts[1];
    }
    if (key){
      const label = form.querySelector(`[data-percent-label="${CSS.escape(key)}"]`);
      if (label) label.textContent = `${perc}%`;
    }
    const base = calcBaseFromForm(form);
    const newPrice = Math.floor(base * (perc/100) + 1e-9);
    const priceInput = form.querySelector('input[name="price"]');
    if (priceInput && isFinite(newPrice)) priceInput.value = newPrice;
  }

  const sliderThrottleState = new WeakMap();
  const SLIDER_THROTTLE_MS = 90;

  function scheduleSliderUpdate(slider, form){
    let state = sliderThrottleState.get(slider);
    if (!state){
      state = { lastRun: 0, timer: null };
      sliderThrottleState.set(slider, state);
    }

    const now = performance.now();
    const invoke = () => {
      state.lastRun = performance.now();
      if (state.timer){
        clearTimeout(state.timer);
        state.timer = null;
      }
      const perc = clampPercent(Number(slider.value));
      applyPercent(form, perc, 'slider');
    };

    if (now - state.lastRun >= SLIDER_THROTTLE_MS){
      invoke();
    } else {
      if (state.timer) clearTimeout(state.timer);
      state.timer = setTimeout(invoke, SLIDER_THROTTLE_MS - (now - state.lastRun));
    }
  }

  table.addEventListener('input', (e) => {
    const num = e.target.closest('input[name="percent"]');
    if (!num) return;
    const form = num.closest('form.quick-form');
    if (!form) return;
    const perc = clampPercent(Number(num.value));
    applyPercent(form, perc, 'number');
  });
  table.addEventListener('input', (e) => {
    const slider = e.target.closest('input[type="range"][data-bind-to]');
    if (!slider) return;
    const form = slider.closest('form.quick-form');
    if (!form) return;
    scheduleSliderUpdate(slider, form);
  });
  table.addEventListener('change', (e) => {
    const slider = e.target.closest('input[type="range"][data-bind-to]');
    if (!slider) return;
    const form = slider.closest('form.quick-form');
    if (!form) return;
    scheduleSliderUpdate(slider, form);
  });
  table.addEventListener('click', (e) => {
    const btn = e.target.closest('button[data-delta]');
    if (!btn) return;
    const form = btn.closest('form.quick-form');
    if (!form) return;
    const percentInput = form.querySelector('input[name="percent"]');
    let curr = Number(percentInput?.value || 0);
    let delta = Number(btn.dataset.delta || 0);
    if (e.shiftKey) delta *= 5;
    const next = clampPercent(curr + delta);
    applyPercent(form, next, 'button');
  });

  // === –¢—Ä–µ–Ω–¥-–∫–Ω–æ–ø–∫–∏ ===
  function syncTrendButtons(form){
    const select = form.querySelector('select[name="trend"]');
    const upBtn = form.querySelector('.btn-trend.btn-up');
    const downBtn = form.querySelector('.btn-trend.btn-down');
    if (!select || !upBtn || !downBtn) return;
    const val = (select.value || '').toLowerCase();
    const isUp = val === 'up';
    upBtn.classList.toggle('is-active', isUp);
    downBtn.classList.toggle('is-active', !isUp);
    upBtn.setAttribute('aria-pressed', String(isUp));
    downBtn.setAttribute('aria-pressed', String(!isUp));
  }
  table.addEventListener('click', (e) => {
    const tbtn = e.target.closest('button[data-trend]');
    if (!tbtn) return;
    const form = tbtn.closest('form.quick-form');
    if (!form) return;
    const select = form.querySelector('select[name="trend"]');
    if (!select) return;
    select.value = tbtn.dataset.trend === 'down' ? 'down' : 'up';
    syncTrendButtons(form);
  });

  // === AJAX-—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ ===
  table.addEventListener('submit', async (e) => {
    const form = e.target.closest('form.quick-form');
    if (!form) return;
    e.preventDefault();

    const id = form.closest('tr').id.replace('editor-','');
    const submitBtn = form.querySelector('button[type="submit"]');
    const orig = submitBtn.textContent;
    submitBtn.disabled = true; submitBtn.textContent = '{{ t("saving") }}';

    try{
      const resp = await fetch(form.action, { method: 'POST', body: new FormData(form) });
      if (!resp.ok) throw new Error('HTTP '+resp.status);

      const price   = form.price.value || '';
      const trend   = form.trend.value || '';
      const percent = form.percent.value || '';

      const row = table.querySelector('tr[data-row="'+id+'"]');
      if (row){
        const priceNode = row.querySelector('[data-field="price"]');
        if (priceNode) priceNode.textContent = Number(price).toFixed(0);

        const percentNode = row.querySelector('[data-field="percent"]');
        if (percentNode) percentNode.textContent = `${Number(percent).toFixed(0)}%`;

        const trendNode = row.querySelector('[data-field="trend"]');
        if (trendNode) {
          trendNode.innerHTML = trend === 'up'
            ? `<span class="badge badge-green">{{ t('up') }}</span>`
            : `<span class="badge badge-red">{{ t('down') }}</span>`;
        }

        // –ü–∏—à–µ–º –º–æ–º–µ–Ω—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ UTC (ISO —Å Z) –∏ —Å—Ä–∞–∑—É —Ä–µ–Ω–¥–µ—Ä–∏–º –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ–µ
        const updatedCell = row.querySelector('[data-col="updated"]');
        if (updatedCell){
          const nowIsoUtc = new Date().toISOString(); // UTC ISO, —Å Z
          updatedCell.setAttribute('data-updated-iso', nowIsoUtc);
          updatedCell.textContent = relLabel(nowIsoUtc, "{{ lang }}");
        }
      }
      toggleEditor(id, false);
    }catch(err){
      form.submit(); // —Ñ–æ–ª–±—ç–∫
    }finally{
      submitBtn.disabled = false; submitBtn.textContent = orig;
    }
  });

  // —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Ç—Ä–µ–Ω–¥-–∫–Ω–æ–ø–æ–∫ –Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π
  table.querySelectorAll('tr[id^="editor-"] form.quick-form').forEach(syncTrendButtons);
})();
</script>
{% endblock %}
