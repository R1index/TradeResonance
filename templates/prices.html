{% extends "base.html" %}
{% block content %}
<section class="card p-4">
  <div class="flex items-center justify-between mb-4">
    <h1 class="text-xl font-semibold">{{ t('nav_prices') }}</h1>
    <div class="flex gap-2">
      <a class="btn btn-outline"
         href="{{ url_for('export_csv') }}?city={{ q_city }}&product={{ q_product }}&trend={{ q_trend }}
         &price_min={{ q_price_min }}&price_max={{ q_price_max }}
         &percent_min={{ q_percent_min }}&percent_max={{ q_percent_max }}
         &prod={{ q_prod }}&sort={{ q_sort }}&lang={{ lang }}">
        Export CSV
      </a>
      <a href="{{ url_for('new_entry', lang=lang) }}" class="btn btn-primary">{{ t('nav_add') }}</a>
    </div>
  </div>

  <!-- ФИЛЬТРЫ -->
  <form class="grid grid-cols-1 md:grid-cols-6 gap-3 mb-3" method="get">
    <input type="hidden" name="tab" value="prices">

    <div>
      <label class="label">{{ t('city') }}</label>
      <input class="input" name="city" placeholder="{{ t('city') }}" value="{{ q_city }}" list="citiesList">
      <datalist id="citiesList">{% for c in cities_list %}<option value="{{ c }}">{% endfor %}</datalist>
    </div>

    <div>
      <label class="label">{{ t('product') }}</label>
      <input class="input" name="product" placeholder="{{ t('product') }}" value="{{ q_product }}" list="productsList">
      <datalist id="productsList">{% for p in products_list %}<option value="{{ p }}">{% endfor %}</datalist>
    </div>

    <div>
      <label class="label">{{ t('trend') }}</label>
      <select class="select" name="trend">
        <option value="">{{ t('trend') }}</option>
        <option value="up"   {% if q_trend=='up' %}selected{% endif %}>{{ t('up') }}</option>
        <option value="down" {% if q_trend=='down' %}selected{% endif %}>{{ t('down') }}</option>
      </select>
    </div>

    <div>
      <label class="label">{{ t('price') }} ≥</label>
      <input class="input" type="number" step="1" name="price_min" value="{{ q_price_min or '' }}">
    </div>
    <div>
      <label class="label">{{ t('price') }} ≤</label>
      <input class="input" type="number" step="1" name="price_max" value="{{ q_price_max or '' }}">
    </div>

    <div>
      <label class="label">{{ t('percent') }}% ≥</label>
      <input class="input" type="number" step="1" name="percent_min" value="{{ q_percent_min or '' }}">
    </div>
    <div>
      <label class="label">{{ t('percent') }}% ≤</label>
      <input class="input" type="number" step="1" name="percent_max" value="{{ q_percent_max or '' }}">
    </div>

    <div>
      <label class="label">{{ t('is_prod_city') }}</label>
      <select class="select" name="prod">
        <option value="any" {% if q_prod=='any' %}selected{% endif %}>—</option>
        <option value="yes" {% if q_prod=='yes' %}selected{% endif %}>{{ t('yes') }}</option>
        <option value="no"  {% if q_prod=='no'  %}selected{% endif %}>{{ t('no') }}</option>
      </select>
    </div>

    <div>
      <label class="label">Sort</label>
      <select class="select" name="sort">
        <option value="updated_desc" {% if q_sort=='updated_desc' %}selected{% endif %}>Updated ↓</option>
        <option value="updated_asc"  {% if q_sort=='updated_asc'  %}selected{% endif %}>Updated ↑</option>
        <option value="price_desc"   {% if q_sort=='price_desc'   %}selected{% endif %}>Price ↓</option>
        <option value="price_asc"    {% if q_sort=='price_asc'    %}selected{% endif %}>Price ↑</option>
        <option value="percent_desc" {% if q_sort=='percent_desc' %}selected{% endif %}>Percent ↓</option>
        <option value="percent_asc"  {% if q_sort=='percent_asc'  %}selected{% endif %}>Percent ↑</option>
      </select>
    </div>

    <div class="md:col-span-6 flex gap-2">
      <button class="btn btn-outline" type="submit">{{ t('filters') }}</button>
      <a class="btn btn-outline" href="{{ url_for('index', tab='prices', lang=lang) }}">Reset</a>
    </div>
  </form>

  {% if not entries %}
    <p class="text-zinc-500">{{ t('no_data') }}</p>
  {% else %}
  <div class="overflow-x-auto">
    <table class="min-w-full table-card" id="pricesTable">
      <thead class="text-left text-sm text-zinc-600 dark:text-zinc-400">
        <tr>
          <th class="py-2">ID</th>
          <th class="py-2">{{ t('city') }}</th>
          <th class="py-2">{{ t('product') }}</th>
          <th class="py-2">{{ t('price') }}</th>
          <th class="py-2">{{ t('trend') }}</th>
          <th class="py-2">{{ t('percent') }} %</th>
          <th class="py-2">{{ t('is_prod_city') }}</th>
          <th class="py-2">Created</th>
          <th class="py-2">Updated</th>
          <th class="py-2">{{ t('actions') }}</th>
        </tr>
      </thead>

      <tbody class="text-sm">
        {% for e in entries %}
        <!-- основная строка -->
        <tr class="border-b border-zinc-200 dark:border-zinc-800" data-row="{{ e.id }}">
          <td class="py-2">{{ e.id }}</td>
          <td class="py-2">{{ e.city }}</td>

          <!-- Кликабельна вся ячейка, без синего текста -->
          <td class="py-2 click-cell" data-quick-edit="{{ e.id }}" tabindex="0" aria-label="Quick edit {{ e.product }}">
            <span class="click-cell__inner">{{ e.product }}</span>
          </td>

          <td class="py-2" data-col="price">{{ '%.0f' % e.price }}</td>
          <td class="py-2" data-col="trend">
            {% if e.trend=='up' %}
              <span class="badge badge-green">{{ t('up') }}</span>
            {% else %}
              <span class="badge badge-red">{{ t('down') }}</span>
            {% endif %}
          </td>
          <td class="py-2" data-col="percent">{{ '%.0f' % e.percent }}</td>
          <td class="py-2">{{ t('yes') if e.is_production_city else t('no') }}</td>
          <td class="py-2" data-col="created">{{ e.created_at.strftime("%Y-%m-%d %H:%M") }}</td>
          <td class="py-2" data-col="updated">{{ (e.updated_at or e.created_at).strftime("%Y-%m-%d %H:%M") }}</td>
          <td class="py-2">
            <a class="btn btn-outline" href="{{ url_for('edit_entry', entry_id=e.id, lang=lang) }}">{{ t('edit') }}</a>
          </td>
        </tr>

        <!-- строка-редактор -->
        <tr class="hidden bg-[var(--bg)]" id="editor-{{ e.id }}">
          <td colspan="10" class="py-3">
            <form class="flex flex-wrap items-end gap-3 quick-form"
                  method="post"
                  action="{{ url_for('edit_entry', entry_id=e.id, lang=lang) }}">
              <input type="hidden" name="next" value="{{ request.full_path }}">
              <div>
                <label class="label">{{ t('price') }}</label>
                <input class="input w-32" type="number" step="1" name="price" value="{{ '%.0f' % e.price }}">
              </div>
              <div>
                <label class="label">{{ t('trend') }}</label>
                <select class="select w-32" name="trend">
                  <option value="up"   {% if e.trend=='up' %}selected{% endif %}>{{ t('up') }}</option>
                  <option value="down" {% if e.trend=='down' %}selected{% endif %}>{{ t('down') }}</option>
                </select>
              </div>
              <div>
                <label class="label">{{ t('percent') }} %</label>
                <input class="input w-28" type="number" step="1" name="percent" value="{{ '%.0f' % e.percent }}">
              </div>

              <div class="flex gap-2">
                <button class="btn btn-primary" type="submit">{{ t('save') }}</button>
                <button class="btn btn-outline" type="button" data-close="{{ e.id }}">×</button>
              </div>

              <div class="text-xs text-[var(--muted)]">
                {{ t('city') }}: <strong>{{ e.city }}</strong> • {{ t('product') }}: <strong>{{ e.product }}</strong>
              </div>
            </form>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  {% endif %}
</section>

<script>
(function(){
  const table = document.getElementById('pricesTable');
  if (!table) return;

  let openedId = null;

  // клик по всей ячейке
  table.addEventListener('click', (e) => {
    const td = e.target.closest('[data-quick-edit]');
    if (!td) return;
    toggleEditor(td.getAttribute('data-quick-edit'));
  });

  // раскрытие по Enter / Space
  table.addEventListener('keydown', (e) => {
    const td = e.target.closest('[data-quick-edit]');
    if (!td) return;
    if (e.key === 'Enter' || e.key === ' ') {
      e.preventDefault();
      toggleEditor(td.getAttribute('data-quick-edit'));
    }
  });

  table.addEventListener('click', (e) => {
    const btn = e.target.closest('button[data-close]');
    if (!btn) return;
    toggleEditor(btn.getAttribute('data-close'), false);
  });

  function toggleEditor(id, forceOpen){
    const row = document.getElementById('editor-'+id);
    if (!row) return;

    if (openedId && openedId !== id){
      const prev = document.getElementById('editor-'+openedId);
      if (prev) prev.classList.add('hidden');
      openedId = null;
    }

    const willOpen = (forceOpen !== undefined) ? forceOpen : row.classList.contains('hidden');
    row.classList.toggle('hidden', !willOpen);
    openedId = willOpen ? id : null;

    if (willOpen){
      const firstInput = row.querySelector('input[name="price"]');
      if (firstInput) firstInput.focus();
    }
  }

  // AJAX-сохранение
  table.addEventListener('submit', async (e) => {
    const form = e.target.closest('form.quick-form');
    if (!form) return;
    e.preventDefault();

    const id = form.closest('tr').id.replace('editor-','');
    const submitBtn = form.querySelector('button[type="submit"]');
    const orig = submitBtn.textContent;
    submitBtn.disabled = true; submitBtn.textContent = '{{ t("saving") }}';

    try{
      const resp = await fetch(form.action, { method: 'POST', body: new FormData(form) });
      if (!resp.ok) throw new Error('HTTP '+resp.status);

      const price   = form.price.value || '';
      const trend   = form.trend.value || '';
      const percent = form.percent.value || '';

      const row = table.querySelector('tr[data-row="'+id+'"]');
      if (row){
        row.querySelector('[data-col="price"]').textContent = Number(price).toFixed(0);
        row.querySelector('[data-col="percent"]').textContent = Number(percent).toFixed(0);
        const trendCell = row.querySelector('[data-col="trend"]');
        trendCell.innerHTML = trend === 'up'
          ? `<span class="badge badge-green">{{ t('up') }}</span>`
          : `<span class="badge badge-red">{{ t('down') }}</span>`;
        const now = new Date();
        const pad = n => String(n).padStart(2,'0');
        row.querySelector('[data-col="updated"]').textContent =
          `${now.getFullYear()}-${pad(now.getMonth()+1)}-${pad(now.getDate())} ${pad(now.getHours())}:${pad(now.getMinutes())}`;
      }
      toggleEditor(id, false);
    }catch(err){
      form.submit(); // фолбэк
    }finally{
      submitBtn.disabled = false; submitBtn.textContent = orig;
    }
  });
})();
</script>
{% endblock %}
