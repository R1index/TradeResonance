{% extends "base.html" %}
{% block content %}
<section class="card p-4">
  <div class="flex items-center justify-between mb-4">
    <h1 class="text-xl font-semibold">{{ t('nav_prices') }}</h1>
    <div class="flex gap-2">
      <a class="btn btn-outline"
         href="{{ url_for('export_csv') }}?city={{ q_city }}&product={{ q_product }}&trend={{ q_trend }}
         &price_min={{ q_price_min }}&price_max={{ q_price_max }}
         &percent_min={{ q_percent_min }}&percent_max={{ q_percent_max }}
         &prod={{ q_prod }}&sort={{ q_sort }}&lang={{ lang }}">
        Export CSV
      </a>
      <a href="{{ url_for('new_entry', lang=lang) }}" class="btn btn-primary">{{ t('nav_add') }}</a>
    </div>
  </div>

  <!-- ФИЛЬТРЫ -->
  <form class="grid grid-cols-1 md:grid-cols-6 gap-3 mb-3" method="get" id="filtersForm">
    <input type="hidden" name="tab" value="prices">

    <div>
      <label class="label">{{ t('city') }}</label>
      <input class="input" name="city" placeholder="{{ t('city') }}" value="{{ q_city }}" list="citiesList">
      <datalist id="citiesList">{% for c in cities_list %}<option value="{{ c }}">{% endfor %}</datalist>
    </div>

    <div>
      <label class="label">{{ t('product') }}</label>
      <input class="input" name="product" placeholder="{{ t('product') }}" value="{{ q_product }}" list="productsList">
      <datalist id="productsList">{% for p in products_list %}<option value="{{ p }}">{% endfor %}</datalist>
    </div>

    <div>
      <label class="label">{{ t('trend') }}</label>
      <select class="select" name="trend">
        <option value="">{{ t('trend') }}</option>
        <option value="up"   {% if q_trend=='up' %}selected{% endif %}>{{ t('up') }}</option>
        <option value="down" {% if q_trend=='down' %}selected{% endif %}>{{ t('down') }}</option>
      </select>
    </div>

    <div>
      <label class="label">{{ t('price') }} ≥</label>
      <input class="input" type="number" step="1" name="price_min" value="{{ q_price_min or '' }}">
    </div>
    <div>
      <label class="label">{{ t('price') }} ≤</label>
      <input class="input" type="number" step="1" name="price_max" value="{{ q_price_max or '' }}">
    </div>

    <div>
      <label class="label">{{ t('percent') }}% ≥</label>
      <input class="input" type="number" step="1" name="percent_min" value="{{ q_percent_min or '' }}">
    </div>
    <div>
      <label class="label">{{ t('percent') }}% ≤</label>
      <input class="input" type="number" step="1" name="percent_max" value="{{ q_percent_max or '' }}">
    </div>

    <div>
      <label class="label">{{ t('is_prod_city') }}</label>
      <select class="select" name="prod">
        <option value="any" {% if q_prod=='any' %}selected{% endif %}>—</option>
        <option value="yes" {% if q_prod=='yes' %}selected{% endif %}>{{ t('yes') }}</option>
        <option value="no"  {% if q_prod=='no'  %}selected{% endif %}>{{ t('no') }}</option>
      </select>
    </div>

    <div>
      <label class="label">Sort</label>
      <select class="select" name="sort">
        <option value="updated_desc" {% if q_sort=='updated_desc' %}selected{% endif %}>Updated ↓</option>
        <option value="updated_asc"  {% if q_sort=='updated_asc'  %}selected{% endif %}>Updated ↑</option>
        <option value="price_desc"   {% if q_sort=='price_desc'   %}selected{% endif %}>Price ↓</option>
        <option value="price_asc"    {% if q_sort=='price_asc'    %}selected{% endif %}>Price ↑</option>
        <option value="percent_desc" {% if q_sort=='percent_desc' %}selected{% endif %}>Percent ↓</option>
        <option value="percent_asc"  {% if q_sort=='percent_asc'  %}selected{% endif %}>Percent ↑</option>
      </select>
    </div>

    <!-- опционально: выбор размера страницы -->
    <div>
      <label class="label">Per page</label>
      <input class="input" type="number" min="1" max="500" name="per_page" value="{{ per_page }}">
    </div>

    <div class="md:col-span-6 flex gap-2">
      <button class="btn btn-outline" type="submit">{{ t('filters') }}</button>
      <a class="btn btn-outline" href="{{ url_for('index', tab='prices', lang=lang) }}">Reset</a>
    </div>
  </form>

  {% if not entries %}
    <p class="text-zinc-500">{{ t('no_data') }}</p>
  {% else %}
  <div class="overflow-x-auto">
    <table class="min-w-full table-card" id="pricesTable">
      <thead class="text-left text-sm text-zinc-600 dark:text-zinc-400">
        <tr>
          <th class="py-2">ID</th>
          <th class="py-2">{{ t('city') }}</th>
          <th class="py-2">{{ t('product') }}</th>
          <th class="py-2">{{ t('price') }}</th>
          <th class="py-2">{{ t('trend') }}</th>
          <th class="py-2">{{ t('percent') }} %</th>
          <th class="py-2">{{ t('is_prod_city') }}</th>
          <th class="py-2">Created</th>
          <th class="py-2">Updated</th>
          <th class="py-2">{{ t('actions') }}</th>
        </tr>
      </thead>

      <tbody class="text-sm">
        {% for e in entries %}
        <!-- основная строка - ВСЯ СТРОКА КЛИКАБЕЛЬНА -->
        <tr class="border-b border-zinc-200 dark:border-zinc-800 clickable-row" 
            data-row="{{ e.id }}" 
            data-quick-edit="{{ e.id }}" 
            tabindex="0"
            aria-label="Quick edit {{ e.city }} - {{ e.product }}">
          <td class="py-2">{{ e.id }}</td>
          <td class="py-2">{{ e.city }}</td>
          <td class="py-2">{{ e.product }}</td>
          <td class="py-2" data-col="price">{{ '%.0f' % e.price }}</td>
          <td class="py-2" data-col="trend">
            {% if e.trend=='up' %}
              <span class="badge badge-green">{{ t('up') }}</span>
            {% else %}
              <span class="badge badge-red">{{ t('down') }}</span>
            {% endif %}
          </td>
          <td class="py-2" data-col="percent">{{ '%.0f' % e.percent }}</td>
          <td class="py-2">{{ t('yes') if e.is_production_city else t('no') }}</td>
          <td class="py-2" data-col="created">{{ e.created_at.strftime("%Y-%m-%d %H:%M") }}</td>
          <td class="py-2" data-col="updated">{{ (e.updated_at or e.created_at).strftime("%Y-%m-%d %H:%M") }}</td>
          <td class="py-2">
            <a class="btn btn-outline" href="{{ url_for('edit_entry', entry_id=e.id, lang=lang) }}">{{ t('edit') }}</a>
          </td>
        </tr>

        <!-- строка-редактор -->
        <tr class="hidden bg-[var(--bg)]" id="editor-{{ e.id }}">
          <td colspan="10" class="py-3">
            <form class="flex flex-wrap items-end gap-3 quick-form"
                  method="post"
                  action="{{ url_for('edit_entry', entry_id=e.id, lang=lang) }}"
                  data-price0="{{ '%.6f' % e.price }}"
                  data-percent0="{{ '%.6f' % e.percent }}">
              <input type="hidden" name="next" value="{{ request.full_path }}">

              <!-- ЦЕНА: только просмотр (readonly), но уходит в POST -->
              <div>
                <label class="label">{{ t('price') }}</label>
                <input class="input w-32" type="number" step="1" name="price"
                       value="{{ '%.0f' % e.price }}" readonly aria-readonly="true"
                       title="{{ 'Auto-calculated from %' if lang=='en' else 'Автоподсчет от %' }}">
              </div>

              <!-- ТРЕНД: кнопки UP/DOWN + нативный select (для сабмита/доступности) -->
              <div class="flex flex-col gap-2">
                <label class="label">{{ t('trend') }}</label>
                <div class="flex items-center gap-2">
                  <button type="button" class="btn btn-trend btn-up" data-trend="up" aria-pressed="false">
                    ▲ {{ t('up') }}
                  </button>
                  <button type="button" class="btn btn-trend btn-down" data-trend="down" aria-pressed="false">
                    ▼ {{ t('down') }}
                  </button>
                </div>
                <select class="select w-32 sr-only" name="trend" aria-hidden="true" tabindex="-1">
                  <option value="up"   {% if e.trend=='up' %}selected{% endif %}>{{ t('up') }}</option>
                  <option value="down" {% if e.trend=='down' %}selected{% endif %}>{{ t('down') }}</option>
                </select>
              </div>

              <!-- ПРОЦЕНТ: число + кнопки - / + + ползунок -->
              <div class="md:col-span-2">
                <label class="label">{{ t('percent') }} %</label>
                <div class="flex items-center gap-3 flex-wrap">
                  <button type="button" class="btn btn-icon" data-delta="-1" aria-label="Minus 1%">−</button>
                  <input class="input w-24" type="number" step="1" min="0" max="200"
                         name="percent" id="percent-{{ e.id }}" value="{{ '%.0f' % e.percent }}">
                  <input type="range" class="w-56" min="0" max="200" step="1"
                         value="{{ '%.0f' % e.percent }}" aria-label="Percent slider"
                         data-bind-to="percent-{{ e.id }}">
                  <button type="button" class="btn btn-icon" data-delta="1" aria-label="Plus 1%">+</button>
                  <span class="text-xs text-[var(--muted)]" data-percent-label="{{ e.id }}">
                    {{ '%.0f' % e.percent }}%
                  </span>
                  <span class="text-[11px] text-[var(--muted)]">
                    {{ 'Shift = step 5' if lang=='en' else 'Shift = шаг 5' }}
                  </span>
                </div>
              </div>

              <div class="flex gap-2">
                <button class="btn btn-primary" type="submit">{{ t('save') }}</button>
                <button class="btn btn-outline" type="button" data-close="{{ e.id }}">×</button>
              </div>

              <div class="text-xs text-[var(--muted)]">
                {{ t('city') }}: <strong>{{ e.city }}</strong> • {{ t('product') }}: <strong>{{ e.product }}</strong>
              </div>
            </form>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- ПАГИНАЦИЯ: окно до 20 страниц -->
  {% if pagination.pages > 1 %}
  <nav class="mt-4 flex flex-wrap items-center justify-center gap-2" aria-label="Pagination">
    {% if pagination.page > 1 %}
      <a class="btn btn-outline px-3" href="{{ url_for('index', tab='prices', lang=lang,
            city=q_city, product=q_product, trend=q_trend,
            price_min=q_price_min, price_max=q_price_max,
            percent_min=q_percent_min, percent_max=q_percent_max,
            prod=q_prod, sort=q_sort, per_page=per_page, page=1) }}">&laquo; First</a>
    {% else %}
      <span class="btn btn-disabled px-3">&laquo; First</span>
    {% endif %}

    {% if pagination.has_prev %}
      <a class="btn btn-outline px-3" href="{{ url_for('index', tab='prices', lang=lang,
            city=q_city, product=q_product, trend=q_trend,
            price_min=q_price_min, price_max=q_price_max,
            percent_min=q_percent_min, percent_max=q_percent_max,
            prod=q_prod, sort=q_sort, per_page=per_page, page=pagination.prev_num) }}">&lsaquo; Prev</a>
    {% else %}
      <span class="btn btn-disabled px-3">&lsaquo; Prev</span>
    {% endif %}

    {% for p in page_numbers %}
      {% if p == pagination.page %}
        <span class="btn btn-primary px-3">{{ p }}</span>
      {% else %}
        <a class="btn btn-outline px-3" href="{{ url_for('index', tab='prices', lang=lang,
              city=q_city, product=q_product, trend=q_trend,
              price_min=q_price_min, price_max=q_price_max,
              percent_min=q_percent_min, percent_max=q_percent_max,
              prod=q_prod, sort=q_sort, per_page=per_page, page=p) }}">{{ p }}</a>
      {% endif %}
    {% endfor %}

    {% if pagination.has_next %}
      <a class="btn btn-outline px-3" href="{{ url_for('index', tab='prices', lang=lang,
            city=q_city, product=q_product, trend=q_trend,
            price_min=q_price_min, price_max=q_price_max,
            percent_min=q_percent_min, percent_max=q_percent_max,
            prod=q_prod, sort=q_sort, per_page=per_page, page=pagination.next_num) }}">Next &rsaquo;</a>
    {% else %}
      <span class="btn btn-disabled px-3">Next &rsaquo;</span>
    {% endif %}

    {% if pagination.page < pagination.pages %}
      <a class="btn btn-outline px-3" href="{{ url_for('index', tab='prices', lang=lang,
            city=q_city, product=q_product, trend=q_trend,
            price_min=q_price_min, price_max=q_price_max,
            percent_min=q_percent_min, percent_max=q_percent_max,
            prod=q_prod, sort=q_sort, per_page=per_page, page=pagination.pages) }}">Last &raquo;</a>
    {% else %}
      <span class="btn btn-disabled px-3">Last &raquo;</span>
    {% endif %}
  </nav>
  {% endif %}
  {% endif %}
</section>

<style>
.clickable-row {
  cursor: pointer;
  transition: background-color 0.2s ease;
}
.clickable-row:hover { background-color: rgba(59, 130, 246, 0.05); }
.clickable-row:focus {
  outline: 2px solid #3b82f6;
  outline-offset: -2px;
}

/* Ползунок — позволяет наследовать основной цвет темы */
input[type="range"] { accent-color: var(--primary, #3b82f6); }

/* Кнопки + / - около слайдера */
.btn-icon {
  padding: 0.25rem 0.5rem;
  min-width: 2rem;
  text-align: center;
}

/* Кнопки тренда */
.btn-trend { padding: 0.4rem 0.75rem; border-radius: 0.5rem; border: 1px solid transparent; }
.btn-up   { background: #16a34a; color:#fff; }
.btn-down { background: #dc2626; color:#fff; }
.btn-trend:is(:hover,:focus) { filter: brightness(0.95); }
.btn-trend.is-active { box-shadow: 0 0 0 2px rgba(255,255,255,0.6) inset; border-color: rgba(255,255,255,0.7); }

/* Скрывающий класс для нативного select тренда, но оставляем в DOM */
.sr-only {
  position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0;
}
</style>

<script>
(function(){
  // Сброс страницы на 1 при применении фильтров
  const filtersForm = document.getElementById('filtersForm');
  if (filtersForm) {
    filtersForm.addEventListener('submit', () => {
      const pageInput = document.createElement('input');
      pageInput.type = 'hidden';
      pageInput.name = 'page';
      pageInput.value = '1';
      filtersForm.appendChild(pageInput);
    });
  }

  const table = document.getElementById('pricesTable');
  if (!table) return;

  let openedId = null;

  // клик по всей строке
  table.addEventListener('click', (e) => {
    const row = e.target.closest('.clickable-row');
    if (!row) return;
    if (e.target.closest('a') || e.target.closest('button')) return;
    toggleEditor(row.getAttribute('data-quick-edit'));
  });

  // раскрытие по Enter / Space для всей строки
  table.addEventListener('keydown', (e) => {
    const row = e.target.closest('.clickable-row');
    if (!row) return;
    if (e.key === 'Enter' || e.key === ' ') {
      e.preventDefault();
      toggleEditor(row.getAttribute('data-quick-edit'));
    }
  });

  // закрытие редактора
  table.addEventListener('click', (e) => {
    const btn = e.target.closest('button[data-close]');
    if (!btn) return;
    toggleEditor(btn.getAttribute('data-close'), false);
  });

  function toggleEditor(id, forceOpen){
    const row = document.getElementById('editor-'+id);
    if (!row) return;

    if (openedId && openedId !== id){
      const prev = document.getElementById('editor-'+openedId);
      if (prev) prev.classList.add('hidden');
      openedId = null;
    }

    const willOpen = (forceOpen !== undefined) ? forceOpen : row.classList.contains('hidden');
    row.classList.toggle('hidden', !willOpen);
    openedId = willOpen ? id : null;

    if (willOpen){
      const firstInput = row.querySelector('input[name="percent"], input[name="price"]');
      if (firstInput) firstInput.focus();
      // при открытии — актуализируем состояние тренд-кнопок
      const form = row.querySelector('form.quick-form');
      if (form) syncTrendButtons(form);
    }
  }

  // === Пересчёт цены при изменении процента (0..200) + синхронизация слайдера ===
  function calcBaseFromForm(form){
    const p0 = Number(form.dataset.price0 || form.price?.defaultValue || form.price?.value || 0);
    const perc0Raw = Number(form.dataset.percent0 || form.percent?.defaultValue || form.percent?.value || 100);
    const perc0 = (isFinite(perc0Raw) && perc0Raw > 0) ? perc0Raw : 100; // если 0/NaN -> 100%
    return p0 / (perc0/100);
  }

  function clampPercent(v){
    if (!isFinite(v)) return 0;
    if (v < 0) return 0;
    if (v > 200) return 200;
    return Math.round(v);
  }

  function applyPercent(form, perc, source){
    // число
    const percentInput = form.querySelector('input[name="percent"]');
    if (percentInput) percentInput.value = perc;

    // слайдер
    const slider = percentInput ? form.querySelector(`input[type="range"][data-bind-to="${percentInput.id}"]`) : null;
    if (slider && source !== 'slider') slider.value = perc;

    // подпись рядом
    let key = null;
    if (percentInput && percentInput.id) {
      const parts = percentInput.id.split('percent-');
      if (parts.length === 2) key = parts[1];
    }
    if (key){
      const label = form.querySelector(`[data-percent-label="${CSS.escape(key)}"]`);
      if (label) label.textContent = `${perc}%`;
    }

    // пересчёт цены (readonly)
    const base = calcBaseFromForm(form);
    const newPrice = Math.round(base * (perc/100));
    const priceInput = form.querySelector('input[name="price"]');
    if (priceInput && isFinite(newPrice)) priceInput.value = newPrice;
  }

  // ввод с клавиатуры в числовом поле процентов
  table.addEventListener('input', (e) => {
    const num = e.target.closest('input[name="percent"]');
    if (!num) return;
    const form = num.closest('form.quick-form');
    if (!form) return;
    const perc = clampPercent(Number(num.value));
    applyPercent(form, perc, 'number');
  });

  // движение ползунка
  table.addEventListener('input', (e) => {
    const slider = e.target.closest('input[type="range"][data-bind-to]');
    if (!slider) return;
    const form = slider.closest('form.quick-form');
    if (!form) return;
    const perc = clampPercent(Number(slider.value));
    applyPercent(form, perc, 'slider');
  });

  // кнопки +/- возле ползунка (Shift = шаг 5)
  table.addEventListener('click', (e) => {
    const btn = e.target.closest('button[data-delta]');
    if (!btn) return;
    const form = btn.closest('form.quick-form');
    if (!form) return;
    const percentInput = form.querySelector('input[name="percent"]');
    let curr = Number(percentInput?.value || 0);
    let delta = Number(btn.dataset.delta || 0);
    if (e.shiftKey) delta *= 5;
    const next = clampPercent(curr + delta);
    applyPercent(form, next, 'button');
  });

  // === Тренд-кнопки (зелёная UP / красная DOWN) ===
  function syncTrendButtons(form){
    const select = form.querySelector('select[name="trend"]');
    const upBtn = form.querySelector('.btn-trend.btn-up');
    const downBtn = form.querySelector('.btn-trend.btn-down');
    if (!select || !upBtn || !downBtn) return;

    const val = (select.value || '').toLowerCase();
    const isUp = val === 'up';

    upBtn.classList.toggle('is-active', isUp);
    downBtn.classList.toggle('is-active', !isUp);
    upBtn.setAttribute('aria-pressed', String(isUp));
    downBtn.setAttribute('aria-pressed', String(!isUp));
  }

  table.addEventListener('click', (e) => {
    const tbtn = e.target.closest('button[data-trend]');
    if (!tbtn) return;
    const form = tbtn.closest('form.quick-form');
    if (!form) return;
    const select = form.querySelector('select[name="trend"]');
    if (!select) return;

    select.value = tbtn.dataset.trend === 'down' ? 'down' : 'up';
    syncTrendButtons(form);
  });
  // === /Тренд-кнопки ===

  // AJAX-сохранение
  table.addEventListener('submit', async (e) => {
    const form = e.target.closest('form.quick-form');
    if (!form) return;
    e.preventDefault();

    const id = form.closest('tr').id.replace('editor-','');
    const submitBtn = form.querySelector('button[type="submit"]');
    const orig = submitBtn.textContent;
    submitBtn.disabled = true; submitBtn.textContent = '{{ t("saving") }}';

    try{
      const resp = await fetch(form.action, { method: 'POST', body: new FormData(form) });
      if (!resp.ok) throw new Error('HTTP '+resp.status);

      const price   = form.price.value || '';
      const trend   = form.trend.value || '';
      const percent = form.percent.value || '';

      const row = table.querySelector('tr[data-row="'+id+'"]');
      if (row){
        row.querySelector('[data-col="price"]').textContent   = Number(price).toFixed(0);
        row.querySelector('[data-col="percent"]').textContent = Number(percent).toFixed(0);
        const trendCell = row.querySelector('[data-col="trend"]');
        trendCell.innerHTML = trend === 'up'
          ? `<span class="badge badge-green">{{ t('up') }}</span>`
          : `<span class="badge badge-red">{{ t('down') }}</span>`;
        const now = new Date();
        const pad = n => String(n).padStart(2,'0');
        row.querySelector('[data-col="updated"]').textContent =
          `${now.getFullYear()}-${pad(now.getMonth()+1)}-${pad(now.getDate())} ${pad(now.getHours())}:${pad(now.getMinutes())}`;
      }
      toggleEditor(id, false);
    }catch(err){
      form.submit(); // фолбэк
    }finally{
      submitBtn.disabled = false; submitBtn.textContent = orig;
    }
  });
})();
</script>
{% endblock %}
