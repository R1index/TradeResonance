{% extends "base.html" %}
{% block content %}
<section class="card p-4">
  <div class="flex items-start justify-between gap-3 mb-4">
    <h1 class="text-xl font-semibold">{{ t('nav_routes') }}</h1>

    <!-- Фильтры -->
    <form method="get" class="grid grid-cols-1 md:grid-cols-6 gap-3 items-end" id="routesFilter">
      <input type="hidden" name="tab" value="routes">
      <input type="hidden" name="lang" value="{{ lang }}">

      <div class="md:col-span-2">
        <label class="label">{{ t('product') }}</label>
        <input class="input" name="product" placeholder="{{ t('product') }}"
               value="{{ q_product or '' }}" list="productsList" id="productInput" autocomplete="off">
        <datalist id="productsList">
          {% for p in products_list %}<option value="{{ p }}">{% endfor %}
        </datalist>
      </div>

      <div>
        <label class="label">{{ 'Items on route (top K)' if lang=='en' else 'Товаров на маршруте (топ K)' }}</label>
        <input class="input" type="number" name="k" min="1" max="10" value="{{ k }}">
      </div>

      <div>
        <label class="label">{{ 'Min items' if lang=='en' else 'Мин. товаров' }}</label>
        <input class="input" type="number" name="min_items" min="1" max="10" value="{{ min_items }}">
      </div>
      <div>
        <label class="label">{{ 'Max items' if lang=='en' else 'Макс. товаров' }}</label>
        <input class="input" type="number" name="max_items" min="1" max="10" value="{{ max_items }}">
      </div>

      <div>
        <label class="label">Sort</label>
        <select class="select" name="sort">
          <option value="sum_profit_desc" {% if sort_by=='sum_profit_desc' %}selected{% endif %}>
            {{ 'Total profit ↓' if lang=='en' else 'Суммарная прибыль ↓' }}
          </option>
          <option value="avg_margin_desc" {% if sort_by=='avg_margin_desc' %}selected{% endif %}>
            {{ 'Avg % ↓' if lang=='en' else 'Средний % ↓' }}
          </option>
          <option value="count_desc" {% if sort_by=='count_desc' %}selected{% endif %}>
            {{ 'Items count ↓' if lang=='en' else 'Кол-во товаров ↓' }}
          </option>
        </select>
      </div>

      <div>
        <label class="label">Per page</label>
        <input class="input" type="number" min="1" max="100" name="per_page" value="{{ per_page }}">
      </div>

      <div class="md:col-span-6 flex gap-2">
        <button class="btn btn-outline" type="submit">{{ t('filters') }}</button>
        <a class="btn btn-outline" href="{{ url_for('index', tab='routes', lang=lang) }}">Reset</a>
      </div>
    </form>
  </div>

  {% if not groups %}
    <p class="text-zinc-500">{{ t('no_data') }}</p>
  {% else %}
  <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4" id="routesGrid">
    {% for g in groups %}
    <div class="route-card p-4 transition hover:shadow-md">
      <div class="flex items-start justify-between mb-2">
        <h3 class="font-semibold text-zinc-900 dark:text-zinc-100">
          {{ g.pair_from }} → {{ g.pair_to }}
        </h3>
        <div class="text-right">
          <div class="text-sm font-medium">
            {{ '%.0f' % g.sum_profit }}
          </div>
          <div class="text-[11px] text-[var(--muted)]">
            {{ 'sum profit' if lang=='en' else 'сумма прибыли' }}
          </div>
        </div>
      </div>

      <div class="text-xs mb-2 text-[var(--muted)]">
        {{ 'Items:' if lang=='en' else 'Товаров:' }} {{ g.items_total }} •
        {{ 'Avg %:' if lang=='en' else 'Средний %:' }} {{ '%.1f' % g.avg_margin }}
      </div>

      <div class="overflow-x-auto">
        <table class="min-w-full table-card">
          <thead class="text-left text-sm text-zinc-600 dark:text-zinc-400">
            <tr>
              <th class="py-2">{{ t('product') }}</th>
              <th class="py-2">{{ t('route_buy') }}</th>
              <th class="py-2">{{ t('route_sell') }}</th>
              <th class="py-2">{{ 'Profit' if lang=='en' else 'Прибыль' }}</th>
              <th class="py-2">{{ t('actions') }}</th>
            </tr>
          </thead>
          <tbody class="text-sm">
            {% for it in g['items'] %}
            <tr class="border-b border-zinc-200 dark:border-zinc-800">
              <td class="py-2">{{ it.product }}</td>
              <td class="py-2">
                {{ it.buy_city }} • {{ '%.0f' % it.buy_price }}
                <span class="badge {{ 'badge-green' if it.buy_trend=='up' else 'badge-red' }}">
                  {{ '%.0f' % it.buy_percent }}%
                </span>
                <a class="btn btn-outline px-2 py-1 text-xs"
                   href="{{ url_for('edit_entry', entry_id=it.buy_entry_id, lang=lang, next=request.full_path) }}">
                  {{ t('edit') }}
                </a>
              </td>
              <td class="py-2">
                {{ it.sell_city }} • {{ '%.0f' % it.sell_price }}
                <span class="badge {{ 'badge-green' if it.sell_trend=='up' else 'badge-red' }}">
                  {{ '%.0f' % it.sell_percent }}%
                </span>
                <a class="btn btn-outline px-2 py-1 text-xs"
                   href="{{ url_for('edit_entry', entry_id=it.sell_entry_id, lang=lang, next=request.full_path) }}">
                  {{ t('edit') }}
                </a>
              </td>
              <td class="py-2">
                {{ '%.0f' % it.profit }} ({{ '%.1f' % it.margin_pct }}%)
              </td>
              <td class="py-2 text-[11px] text-[var(--muted)]" data-updated-iso="{{ it.updated_utc_iso }}"></td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <div class="mt-2 text-xs text-[var(--muted)] flex items-center justify-between">
        <span data-updated-iso="{{ g.updated_utc_iso }}"></span>
      </div>
    </div>
    {% endfor %}
  </div>

  <!-- ПАГИНАЦИЯ -->
  {% if pagination and pagination.pages > 1 %}
  <nav class="mt-4 flex flex-wrap items-center justify-center gap-2" aria-label="Pagination">
    {% if pagination.page > 1 %}
      <a class="btn btn-outline px-3" href="{{ url_for('index', tab='routes', lang=lang,
            product=q_product, k=k, min_items=min_items, max_items=max_items, sort=sort_by,
            per_page=pagination.per_page, page=1) }}">&laquo; First</a>
      <a class="btn btn-outline px-3" href="{{ url_for('index', tab='routes', lang=lang,
            product=q_product, k=k, min_items=min_items, max_items=max_items, sort=sort_by,
            per_page=pagination.per_page, page=pagination.prev_num) }}">&lsaquo; Prev</a>
    {% else %}
      <span class="btn btn-disabled px-3">&laquo; First</span>
      <span class="btn btn-disabled px-3">&lsaquo; Prev</span>
    {% endif %}

    {% for p in page_numbers %}
      {% if p == pagination.page %}
        <span class="btn btn-primary px-3">{{ p }}</span>
      {% else %}
        <a class="btn btn-outline px-3" href="{{ url_for('index', tab='routes', lang=lang,
              product=q_product, k=k, min_items=min_items, max_items=max_items, sort=sort_by,
              per_page=pagination.per_page, page=p) }}">{{ p }}</a>
      {% endif %}
    {% endfor %}

    {% if pagination.has_next %}
      <a class="btn btn-outline px-3" href="{{ url_for('index', tab='routes', lang=lang,
            product=q_product, k=k, min_items=min_items, max_items=max_items, sort=sort_by,
            per_page=pagination.per_page, page=pagination.next_num) }}">Next &rsaquo;</a>
      <a class="btn btn-outline px-3" href="{{ url_for('index', tab='routes', lang=lang,
            product=q_product, k=k, min_items=min_items, max_items=max_items, sort=sort_by,
            per_page=pagination.per_page, page=pagination.pages) }}">Last &raquo;</a>
    {% else %}
      <span class="btn btn-disabled px-3">Next &rsaquo;</span>
      <span class="btn btn-disabled px-3">Last &raquo;</span>
    {% endif %}
  </nav>
  {% endif %}
  {% endif %}
</section>

<script>
(function(){
  // автосабмит: Enter/изменение + сброс page=1
  const f = document.getElementById('routesFilter');
  const prod = document.getElementById('productInput');
  if (f) {
    const toPage1 = () => {
      const pageInput = document.createElement('input');
      pageInput.type = 'hidden';
      pageInput.name = 'page';
      pageInput.value = '1';
      f.appendChild(pageInput);
    };
    f.addEventListener('submit', toPage1);
    if (prod) {
      prod.addEventListener('keydown', e => { if (e.key === 'Enter') { toPage1(); f.submit(); }});
      prod.addEventListener('change', () => { toPage1(); f.submit(); });
    }
  }

  // Относительное время от UTC (ISO с Z)
  function relLabel(dateIso, isEn){
    if (!dateIso) return '';
    const d = new Date(dateIso); // 'Z' → UTC
    if (isNaN(d.getTime())) return '';
    const now = new Date();
    let sec = Math.max(0, Math.floor((now - d) / 1000));
    if (sec < 45) return isEn ? 'just now' : 'только что';
    const min = Math.floor(sec/60);
    if (min < 60) return isEn ? `${min} min ago` : `${min} мин назад`;
    const hr = Math.floor(min/60);
    if (hr < 24) return isEn ? `${hr} h ago` : `${hr} ч назад`;
    const day = Math.floor(hr/24);
    return isEn ? `${day} d ago` : `${day} дн назад`;
  }

  function renderRelative(container){
    const isEn = "{{ lang }}" === "en";
    container.querySelectorAll('[data-updated-iso]').forEach(el => {
      el.textContent = relLabel(el.getAttribute('data-updated-iso'), isEn);
    });
  }

  const root = document.getElementById('routesGrid') || document.currentScript.closest('section');
  if (root){
    renderRelative(root);
    setInterval(() => renderRelative(root), 60*1000);
  }
})();
</script>
{% endblock %}
