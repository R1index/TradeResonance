{% extends "base.html" %}
{% block content %}
{% macro routes_url(page) -%}
  {{ url_for('index', tab='routes', lang=lang,
    product=q_product, buy_city=q_buy_city, sell_city=q_sell_city,
    buy_only_prod=1 if buy_only_prod else 0,
    min_profit=min_profit, min_margin=min_margin,
    min_buy_percent=min_buy_percent, min_sell_percent=min_sell_percent,
    buy_trend=buy_trend, sell_trend=sell_trend,
    max_age_value=max_age_value, max_age_unit=max_age_unit,
    k=k, min_items=min_items, max_items=max_items,
    sort=sort_by, per_page=per_page, page=page) }}
{%- endmacro %}

<section class="card p-4">
  <div class="flex flex-col lg:flex-row lg:items-start lg:justify-between gap-4 mb-4">
    <div class="space-y-2">
      <h1 class="text-xl font-semibold">{{ t('nav_routes') }}</h1>
      {% if pagination %}
      <div class="grid grid-cols-1 sm:grid-cols-3 gap-2 text-sm text-[var(--muted)]">
        <div class="summary-chip">
          <span class="summary-label">{{ 'Routes' if lang=='en' else 'Маршрутов' }}</span>
          <span class="summary-value">{{ pagination.total }}</span>
        </div>
        <div class="summary-chip">
          <span class="summary-label">{{ 'Page' if lang=='en' else 'Страница' }}</span>
          <span class="summary-value">{{ pagination.page }}/{{ pagination.pages }}</span>
        </div>
        <div class="summary-chip">
          <span class="summary-label">{{ 'Per page' if lang=='en' else 'На странице' }}</span>
          <span class="summary-value">{{ per_page }}</span>
        </div>
      </div>
      {% endif %}
    </div>

    {% set routes_filters_active = q_product or q_buy_city or q_sell_city or buy_only_prod or min_profit is not none or min_margin is not none or min_buy_percent is not none or min_sell_percent is not none or buy_trend != 'any' or sell_trend != 'any' or max_age_value is not none or sort_by != 'sum_profit_desc' or per_page != 12 or k != 5 or min_items != 1 or max_items != 10 %}
    <details class="filters-card lg:w-2/3" {% if routes_filters_active %}open{% endif %}>
      <summary class="filters-summary">{{ t('filters') }}</summary>
      <form method="get" class="filters-grid routes-grid" id="routesFilter">
        <input type="hidden" name="tab" value="routes">
        <input type="hidden" name="lang" value="{{ lang }}">

        <div>
          <label class="label">{{ t('product') }}</label>
          <input class="input" name="product" placeholder="{{ t('product') }}"
                 value="{{ q_product or '' }}" list="productsList" id="productInput" autocomplete="off">
          <datalist id="productsList">
            {% for p in products_list %}<option value="{{ p }}">{% endfor %}
          </datalist>
        </div>

        <div>
          <label class="label">{{ 'Buy city' if lang=='en' else 'Город покупки' }}</label>
          <input class="input" name="buy_city" value="{{ q_buy_city or '' }}" list="citiesList" autocomplete="off">
        </div>
        <div>
          <label class="label">{{ 'Sell city' if lang=='en' else 'Город продажи' }}</label>
          <input class="input" name="sell_city" value="{{ q_sell_city or '' }}" list="citiesList" autocomplete="off">
        </div>
        <datalist id="citiesList">
          {% for c in cities_list %}<option value="{{ c }}">{% endfor %}
        </datalist>

        <div class="flex items-center gap-2 mt-6">
          <input id="onlyProd" type="checkbox" class="checkbox" name="buy_only_prod" value="1"
                 {% if buy_only_prod %}checked{% endif %}>
          <label for="onlyProd" class="text-sm">{{ 'Buy only from production cities' if lang=='en' else 'Покупка только из прод-городов' }}</label>
        </div>

        <div>
          <label class="label">{{ 'Top K per route' if lang=='en' else 'Топ K на маршруте' }}</label>
          <input class="input" type="number" name="k" min="1" max="10" value="{{ k }}">
        </div>
        <div>
          <label class="label">{{ 'Min items' if lang=='en' else 'Мин. товаров' }}</label>
          <input class="input" type="number" name="min_items" min="1" max="10" value="{{ min_items }}">
        </div>
        <div>
          <label class="label">{{ 'Max items' if lang=='en' else 'Макс. товаров' }}</label>
          <input class="input" type="number" name="max_items" min="1" max="10" value="{{ max_items }}">
        </div>

        <div>
          <label class="label">{{ 'Min profit' if lang=='en' else 'Мин. прибыль' }}</label>
          <input class="input" type="number" name="min_profit" step="1" value="{{ min_profit or '' }}">
        </div>
        <div>
          <label class="label">{{ 'Min margin %' if lang=='en' else 'Мин. маржа %' }}</label>
          <input class="input" type="number" name="min_margin" step="1" value="{{ min_margin or '' }}">
        </div>
        <div>
          <label class="label">{{ 'Buy % ≥' if lang=='en' else '% покупки ≥' }}</label>
          <input class="input" type="number" name="min_buy_percent" min="0" max="200" step="1" value="{{ min_buy_percent or '' }}">
        </div>
        <div>
          <label class="label">{{ 'Sell % ≥' if lang=='en' else '% продажи ≥' }}</label>
          <input class="input" type="number" name="min_sell_percent" min="0" max="200" step="1" value="{{ min_sell_percent or '' }}">
        </div>

        <div>
          <label class="label">{{ 'Buy trend' if lang=='en' else 'Тренд покупки' }}</label>
          <select class="select" name="buy_trend">
            <option value="any" {% if buy_trend=='any' %}selected{% endif %}>—</option>
            <option value="up" {% if buy_trend=='up' %}selected{% endif %}>{{ t('up') }}</option>
            <option value="down" {% if buy_trend=='down' %}selected{% endif %}>{{ t('down') }}</option>
          </select>
        </div>
        <div>
          <label class="label">{{ 'Sell trend' if lang=='en' else 'Тренд продажи' }}</label>
          <select class="select" name="sell_trend">
            <option value="any" {% if sell_trend=='any' %}selected{% endif %}>—</option>
            <option value="up" {% if sell_trend=='up' %}selected{% endif %}>{{ t('up') }}</option>
            <option value="down" {% if sell_trend=='down' %}selected{% endif %}>{{ t('down') }}</option>
          </select>
        </div>

        <div class="md:col-span-2">
          <label class="label">{{ 'Max age (UTC)' if lang=='en' else 'Макс. давность (UTC)' }}</label>
          <div class="flex gap-2">
            <input class="input w-24" type="number" name="max_age_value" min="0" step="1" value="{{ max_age_value or '' }}">
            <select class="select" name="max_age_unit">
              <option value="m" {% if max_age_unit=='m' %}selected{% endif %}>{{ 'minutes' if lang=='en' else 'минут' }}</option>
              <option value="h" {% if max_age_unit=='h' %}selected{% endif %}>{{ 'hours' if lang=='en' else 'часов' }}</option>
              <option value="d" {% if max_age_unit=='d' %}selected{% endif %}>{{ 'days' if lang=='en' else 'дней' }}</option>
            </select>
          </div>
        </div>

        <div>
          <label class="label">Sort</label>
          <select class="select" name="sort">
            <option value="sum_profit_desc" {% if sort_by=='sum_profit_desc' %}selected{% endif %}>
              {{ 'Total profit ↓' if lang=='en' else 'Суммарная прибыль ↓' }}
            </option>
            <option value="avg_margin_desc" {% if sort_by=='avg_margin_desc' %}selected{% endif %}>
              {{ 'Avg % ↓' if lang=='en' else 'Средний % ↓' }}
            </option>
            <option value="count_desc" {% if sort_by=='count_desc' %}selected{% endif %}>
              {{ 'Items count ↓' if lang=='en' else 'Кол-во товаров ↓' }}
            </option>
            <option value="fresh_desc" {% if sort_by=='fresh_desc' %}selected{% endif %}>
              {{ 'Fresh first ↓' if lang=='en' else 'Сначала свежие ↓' }}
            </option>
          </select>
        </div>
        <div>
          <label class="label">Per page</label>
          <input class="input" type="number" min="1" max="100" name="per_page" value="{{ per_page }}">
        </div>

        <div class="md:col-span-12 flex gap-2">
          <button class="btn btn-primary" type="submit">{{ t('filters') }}</button>
          <a class="btn btn-outline" href="{{ url_for('index', tab='routes', lang=lang) }}">Reset</a>
        </div>
      </form>
    </details>
  </div>

  {% if not groups %}
    <p class="text-zinc-500">{{ t('no_data') }}</p>
  {% else %}
  <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4" id="routesGrid">
    {% for g in groups %}
    <div class="route-card p-4 transition hover:shadow-md">
      <div class="flex items-start justify-between mb-2">
        <h3 class="font-semibold text-zinc-900 dark:text-zinc-100">
          {{ g.pair_from }} → {{ g.pair_to }}
        </h3>
        <div class="text-right">
          <div class="text-sm font-medium">{{ '%.0f' % g.sum_profit }}</div>
          <div class="text-[11px] text-[var(--muted)]">{{ 'sum profit' if lang=='en' else 'сумма прибыли' }}</div>
        </div>
      </div>

      <div class="text-xs mb-2 text-[var(--muted)]">
        {{ 'Items:' if lang=='en' else 'Товаров:' }} {{ g.items_total }} •
        {{ 'Avg %:' if lang=='en' else 'Средний %:' }} {{ '%.1f' % g.avg_margin }}
      </div>

      <div class="overflow-x-auto">
        <table class="min-w-full table-card stacked-table">
          <thead class="text-left text-sm text-zinc-600 dark:text-zinc-400">
            <tr>
              <th class="py-2 w-[30%]">{{ t('product') }}</th>
              <th class="py-2 w-[35%]">{{ t('route_buy') }}</th>
              <th class="py-2 w-[35%]">{{ t('route_sell') }}</th>
              <th class="py-2 text-right">{{ 'Profit' if lang=='en' else 'Прибыль' }}</th>
            </tr>
          </thead>
          <tbody class="text-sm">
            {% for it in g.entries %}
            <tr class="border-b border-zinc-200 dark:border-zinc-800 align-top">
              <td class="py-2" data-label="{{ t('product') }}">
                <div class="font-medium">{{ it.product }}</div>
              </td>

              <td class="py-2" data-label="{{ t('route_buy') }}">
                <div class="flex flex-wrap items-center gap-2">
                  <span class="font-medium">{{ it.buy_city }}</span>
                  <span>• {{ '%.0f' % it.buy_price }}</span>
                  <span class="badge {{ 'badge-green' if it.buy_trend=='up' else 'badge-red' }}">
                    {{ it.buy_percent is not none and ('%.0f' % it.buy_percent) or '—' }}%
                  </span>
                  <a class="btn btn-outline px-2 py-1 text-xs"
                     href="{{ url_for('edit_entry', entry_id=it.buy_entry_id, lang=lang, next=request.full_path) }}">
                    {{ t('edit') }}
                  </a>
                </div>
                <div class="text-[11px] text-[var(--muted)] mt-1">
                  {{ 'updated' if lang=='en' else 'обновлено' }}:
                  <span data-updated-iso="{{ it.buy_updated_iso }}"></span>
                </div>
              </td>

              <td class="py-2" data-label="{{ t('route_sell') }}">
                <div class="flex flex-wrap items-center gap-2">
                  <span class="font-medium">{{ it.sell_city }}</span>
                  <span>• {{ '%.0f' % it.sell_price }}</span>
                  <span class="badge {{ 'badge-green' if it.sell_trend=='up' else 'badge-red' }}">
                    {{ it.sell_percent is not none and ('%.0f' % it.sell_percent) or '—' }}%
                  </span>
                  <a class="btn btn-outline px-2 py-1 text-xs"
                     href="{{ url_for('edit_entry', entry_id=it.sell_entry_id, lang=lang, next=request.full_path) }}">
                    {{ t('edit') }}
                  </a>
                </div>
                <div class="text-[11px] text-[var(--muted)] mt-1">
                  {{ 'updated' if lang=='en' else 'обновлено' }}:
                  <span data-updated-iso="{{ it.sell_updated_iso }}"></span>
                </div>
              </td>

              <td class="py-2 text-right whitespace-nowrap" data-label="{{ 'Profit' if lang=='en' else 'Прибыль' }}">
                <div class="font-medium">+{{ '%.0f' % it.profit }}</div>
                <div class="text-[11px] text-[var(--muted)]">{{ '%.1f' % it.margin_pct }}%</div>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <div class="mt-2 text-xs text-[var(--muted)] flex items-center justify-between">
        <span data-updated-iso="{{ g.updated_utc_iso }}"></span>
      </div>
    </div>
    {% endfor %}
  </div>

  {% if pagination and pagination.pages > 1 %}
  {% set prev_page = pagination.page - 1 %}
  {% set next_page = pagination.page + 1 %}
  <nav class="mt-4 flex flex-wrap items-center justify-center gap-2" aria-label="Pagination">
    {% if pagination.page > 1 %}
      <a class="btn btn-outline px-3" href="{{ routes_url(1) }}">&laquo; First</a>
      <a class="btn btn-outline px-3" href="{{ routes_url(prev_page) }}">&lsaquo; Prev</a>
    {% else %}
      <span class="btn btn-disabled px-3">&laquo; First</span>
      <span class="btn btn-disabled px-3">&lsaquo; Prev</span>
    {% endif %}

    {% for p in page_numbers %}
      {% if p == pagination.page %}
        <span class="btn btn-primary px-3">{{ p }}</span>
      {% else %}
        <a class="btn btn-outline px-3" href="{{ routes_url(p) }}">{{ p }}</a>
      {% endif %}
    {% endfor %}

    {% if pagination.page < pagination.pages %}
      <a class="btn btn-outline px-3" href="{{ routes_url(next_page) }}">Next &rsaquo;</a>
      <a class="btn btn-outline px-3" href="{{ routes_url(pagination.pages) }}">Last &raquo;</a>
    {% else %}
      <span class="btn btn-disabled px-3">Next &rsaquo;</span>
      <span class="btn btn-disabled px-3">Last &raquo;</span>
    {% endif %}
  </nav>
  {% endif %}
  {% endif %}
</section>

<script>
(function(){
  const f = document.getElementById('routesFilter');
  const prod = document.getElementById('productInput');
  if (f) {
    const ensurePageInput = () => {
      let pageInput = f.querySelector('input[name="page"]');
      if (!pageInput) {
        pageInput = document.createElement('input');
        pageInput.type = 'hidden';
        pageInput.name = 'page';
        f.appendChild(pageInput);
      }
      pageInput.value = '1';
    };
    f.addEventListener('submit', ensurePageInput);
    if (prod) {
      prod.addEventListener('keydown', e => { if (e.key === 'Enter') { ensurePageInput(); f.submit(); }});
      prod.addEventListener('change', () => { ensurePageInput(); f.submit(); });
    }
    f.querySelectorAll('select, input[type=checkbox]').forEach(el=>{
      el.addEventListener('change', ()=>{ ensurePageInput(); f.submit(); });
    });
  }

  function relLabel(dateIso, isEn){
    if (!dateIso) return '';
    const d = new Date(dateIso);
    if (isNaN(d.getTime())) return '';
    const now = new Date();
    const sec = Math.max(0, Math.floor((now - d) / 1000));
    if (sec < 45) return isEn ? 'just now' : 'только что';
    const min = Math.floor(sec/60);
    if (min < 60) return isEn ? `${min} min ago` : `${min} мин назад`;
    const hr = Math.floor(min/60);
    if (hr < 24) return isEn ? `${hr} h ago` : `${hr} ч назад`;
    const day = Math.floor(hr/24);
    return isEn ? `${day} d ago` : `${day} дн назад`;
  }

  function renderRelative(root){
    const isEn = "{{ lang }}" === "en";
    root.querySelectorAll('[data-updated-iso]').forEach(el => {
      el.textContent = relLabel(el.getAttribute('data-updated-iso'), isEn);
    });
  }

  const root = document.getElementById('routesGrid') || document.currentScript.closest('section');
  if (root){
    renderRelative(root);
    setInterval(() => renderRelative(root), 60*1000);
  }
})();
</script>
{% endblock %}
