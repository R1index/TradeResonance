<!doctype html>
<html lang="{{ lang or 'ru' }}" class="h-full">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>{{ t('app_title') }}</title>
    <meta name="color-scheme" content="light dark">

    <script>
      (function () {
        try {
          const prefers = window.matchMedia('(prefers-color-scheme: dark)').matches;
          const stored = localStorage.getItem('tr-theme');
          const theme = stored || (prefers ? 'dark' : 'light');
          const root = document.documentElement;
          root.classList.toggle('dark', theme === 'dark');
          document.documentElement.dataset.theme = theme;
        } catch (err) {
          console.warn('Theme init failed', err);
        }
      })();
    </script>

    <script>
      window.tailwind = { config: { darkMode: 'class' } };
    </script>
    <script src="https://cdn.tailwindcss.com?plugins=forms,typography"></script>

    <link rel="stylesheet" href="{{ url_for('static', filename='tw-app.css') }}">
    {% block head %}{% endblock %}
  </head>
  <body class="min-h-full bg-surface text-foreground antialiased">
    <div class="min-h-screen flex flex-col">
      <header class="border-b border-divider/60 bg-surface/80 backdrop-blur supports-[backdrop-filter]:bg-surface/70 sticky top-0 z-40">
        <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 py-4 flex items-center justify-between gap-4">
          <a href="{{ url_for('web.dashboard', lang=lang) }}" class="flex items-center gap-3 text-lg font-semibold hover:text-accent transition">
            <span class="text-2xl">ðŸ§­</span>
            <span>{{ t('app_title') }}</span>
          </a>
          <nav class="hidden md:flex items-center gap-2 text-sm" hx-boost="true">
            <a href="{{ url_for('web.dashboard', tab='prices', lang=lang) }}" class="nav-pill {{ 'nav-pill-active' if tab=='prices' else '' }}">{{ t('nav_prices') }}</a>
            <a href="{{ url_for('web.dashboard', tab='cities', lang=lang) }}" class="nav-pill {{ 'nav-pill-active' if tab=='cities' else '' }}">{{ t('nav_cities') }}</a>
            <a href="{{ url_for('web.dashboard', tab='routes', lang=lang) }}" class="nav-pill {{ 'nav-pill-active' if tab=='routes' else '' }}">{{ t('nav_routes') }}</a>
            <a href="{{ url_for('web.new_entry', lang=lang) }}" class="nav-pill">{{ t('nav_add') }}</a>
            <a href="{{ url_for('web.import_csv', lang=lang) }}" class="nav-pill">{{ t('nav_import') }}</a>
          </nav>
          <div class="flex items-center gap-2">
            <div class="hidden sm:flex items-center text-xs font-mono text-muted">
              <span class="mr-3" title="Coordinated Universal Time">UTC <span id="clock-utc">--:--:--</span></span>
              <span><span id="clock-tz">UTC</span> <span id="clock-local">--:--:--</span></span>
            </div>
            <div class="flex border border-divider/70 rounded-full overflow-hidden text-xs">
              <a href="?lang=en" class="lang-pill {{ 'lang-pill-active' if lang=='en' else '' }}">EN</a>
              <a href="?lang=ru" class="lang-pill {{ 'lang-pill-active' if lang=='ru' else '' }}">RU</a>
            </div>
            <button type="button" id="theme-toggle" class="icon-btn" aria-label="Toggle theme">ðŸŒ—</button>
            <button type="button" class="icon-btn md:hidden" data-drawer-toggle aria-expanded="false">â˜°</button>
          </div>
        </div>
        <div class="md:hidden hidden border-t border-divider/70" id="mobile-drawer">
          <nav class="px-4 py-4 space-y-2 text-sm" hx-boost="true">
            <a href="{{ url_for('web.dashboard', tab='prices', lang=lang) }}" class="mobile-link">{{ t('nav_prices') }}</a>
            <a href="{{ url_for('web.dashboard', tab='cities', lang=lang) }}" class="mobile-link">{{ t('nav_cities') }}</a>
            <a href="{{ url_for('web.dashboard', tab='routes', lang=lang) }}" class="mobile-link">{{ t('nav_routes') }}</a>
            <a href="{{ url_for('web.new_entry', lang=lang) }}" class="mobile-link">{{ t('nav_add') }}</a>
            <a href="{{ url_for('web.import_csv', lang=lang) }}" class="mobile-link">{{ t('nav_import') }}</a>
          </nav>
        </div>
      </header>

      <main class="flex-1">
        {% with flashes = get_flashed_messages(with_categories=true) %}
          {% if flashes %}
            <div id="flash-data" data-flashes='{{ flashes | tojson }}'></div>
          {% endif %}
        {% endwith %}
        {% block content %}{% endblock %}
      </main>

      <footer class="border-t border-divider/60 bg-muted/10">
        <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 py-4 text-xs text-muted flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2">
          <span>Resonance Solstice helper â€¢ {{ current_year }}</span>
          <span class="flex items-center gap-1">
            <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M3 3h7l2 3h9v12H3z"/><path d="M3 12h18"/></svg>
            <span>Railway ready</span>
          </span>
        </div>
      </footer>
    </div>

    <div id="toast-root" class="fixed top-4 right-4 z-50 space-y-2"></div>

    <script src="https://unpkg.com/htmx.org@1.9.12"></script>
    <script src="{{ url_for('static', filename='tw-app.js') }}"></script>
    {% block scripts %}{% endblock %}
  </body>
</html>
