<!doctype html>
<html lang="{{ 'en' if lang=='en' else 'ru' }}" class="h-full">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>{{ t('app_title') }}</title>

    <!-- 1) –†–∞–Ω–Ω–∏–π –±—É—Ç —Ç–µ–º—ã (–¥–æ Tailwind), –¥–µ—Ñ–æ–ª—Ç ‚Äî —Å–≤–µ—Ç–ª–∞—è -->
    <script>
      (function () {
        try {
          const saved = localStorage.getItem('theme'); // 'dark' | 'light' | null
          const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
          const enableDark = saved ? saved === 'dark' : prefersDark;
          const root = document.documentElement;
          if (enableDark) root.classList.add('dark'); else root.classList.remove('dark');

          // –ø–æ–¥—Å–∫–∞–∑–∫–∞ –¥–ª—è –Ω–∞—Ç–∏–≤–Ω—ã—Ö –∫–æ–Ω—Ç—Ä–æ–ª–æ–≤
          let meta = document.querySelector('meta[name="color-scheme"]');
          if (!meta) { meta = document.createElement('meta'); meta.name = 'color-scheme'; document.head.appendChild(meta); }
          meta.content = enableDark ? 'dark light' : 'light dark';
        } catch {}
      })();
    </script>

    <!-- 2) Tailwind (darkMode: 'class') -->
    <script>
      window.tailwind = { config: { darkMode: 'class' } };
    </script>
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- 3) –ù–∞—à–∏ —Å—Ç–∏–ª–∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ -->
    <link rel="stylesheet" href="{{ url_for('static', filename='tw-app.css') }}">
  </head>

  <body class="min-h-full bg-[var(--bg)] text-[var(--fg)] transition-colors">
    <!-- —Ñ–ª—ç—à-—Ç–æ—Å—Ç—ã -->
    <div id="toast-zone" class="fixed top-4 right-4 z-50 space-y-2"></div>
    {% set flash_msg = (get_flashed_messages() or [])|first %}
    <div data-flash='{{ {"message": flash_msg, "type": "success"} | tojson if flash_msg else "" }}' class="hidden"></div>

    <!-- –•–µ–¥–µ—Ä -->
    <header class="sticky top-0 z-40 border-b border-[var(--border)] bg-[var(--header-bg)]/70 backdrop-blur">
      <div class="mx-auto max-w-7xl px-3 sm:px-6 py-3 flex flex-wrap items-center justify-between gap-3">
        <a href="{{ url_for('index', lang=lang) }}" class="flex items-center gap-2 font-semibold tracking-tight text-lg">
          <span>üß≠</span><span>{{ t('app_title') }}</span>
        </a>

        <nav class="hidden md:flex items-center gap-1">
          <a class="tab {{ 'tab-active' if request.args.get('tab','prices')=='prices' else '' }}" href="{{ url_for('index', tab='prices', lang=lang) }}">{{ t('nav_prices') }}</a>
          <a class="tab {{ 'tab-active' if request.args.get('tab')=='dynamics' else '' }}" href="{{ url_for('index', tab='dynamics', lang=lang) }}">{{ t('nav_dynamics') }}</a>
          <a class="tab {{ 'tab-active' if request.args.get('tab')=='routes' else '' }}" href="{{ url_for('index', tab='routes', lang=lang) }}">{{ t('nav_routes') }}</a>
          <a class="tab" href="{{ url_for('new_entry', lang=lang) }}">{{ t('nav_add') }}</a>
          <a class="tab" href="{{ url_for('import_csv', lang=lang) }}">{{ t('nav_import') }}</a>
        </nav>

        <div class="flex items-center gap-3">
          <!-- UTC / Local -->
          <div class="hidden sm:flex flex-col items-end leading-4">
            <div class="text-[11px] sm:text-xs font-mono text-[var(--muted)]" title="Coordinated Universal Time">
              UTC <span id="clockUTC">--:--:--</span>
            </div>
            <div class="text-[11px] sm:text-xs font-mono text-[var(--muted-2)]">
              <span id="clockLocalTz">LOCAL</span> <span id="clockLocal">--:--:--</span>
            </div>
          </div>

          <div class="hidden sm:flex rounded-lg overflow-hidden border border-[var(--border)]">
            <a class="px-3 py-1.5 hover:bg-[var(--hover)] {{ 'bg-[var(--hover)]' if lang=='en' else '' }}" href="?lang=en">EN</a>
            <a class="px-3 py-1.5 hover:bg-[var(--hover)] {{ 'bg-[var(--hover)]' if lang=='ru' else '' }}" href="?lang=ru">RU</a>
          </div>
          <button id="themeToggle" class="icon-btn" title="Toggle theme" aria-label="Toggle theme">üåì</button>
          <button class="icon-btn md:hidden" id="menuBtn" aria-label="Menu" aria-expanded="false">‚ò∞</button>
        </div>
      </div>

      <!-- –º–æ–±–∏–ª—å–Ω–æ–µ –º–µ–Ω—é -->
      <div id="mobileMenu" class="md:hidden hidden border-t border-[var(--border)] bg-[var(--bg-soft)]">
        <div class="mx-auto max-w-7xl px-3 sm:px-6 py-2 grid gap-2">
          <div class="flex items-center justify-between text-xs font-mono text-[var(--muted)]">
            <span>UTC <span id="mClockUTC">--:--:--</span></span>
            <span><span id="mClockLocalTz">LOCAL</span> <span id="mClockLocal">--:--:--</span></span>
          </div>
          <a class="tab block" href="{{ url_for('index', tab='prices', lang=lang) }}">{{ t('nav_prices') }}</a>
          <a class="tab block" href="{{ url_for('index', tab='dynamics', lang=lang) }}">{{ t('nav_dynamics') }}</a>
          <a class="tab block" href="{{ url_for('index', tab='routes', lang=lang) }}">{{ t('nav_routes') }}</a>
          <a class="tab block" href="{{ url_for('new_entry', lang=lang) }}">{{ t('nav_add') }}</a>
          <a class="tab block" href="{{ url_for('import_csv', lang=lang) }}">{{ t('nav_import') }}</a>
          <div class="flex gap-2">
            <a class="btn btn-outline flex-1 text-center" href="?lang=en">EN</a>
            <a class="btn btn-outline flex-1 text-center" href="?lang=ru">RU</a>
          </div>
        </div>
      </div>
    </header>

    <main class="mx-auto max-w-7xl px-3 sm:px-6 py-6 space-y-6">
      {% block content %}{% endblock %}
    </main>

    <script>
      window.PRODUCT_SUGGESTIONS = {{ (product_suggestions or []) | tojson }};
    </script>
    <script src="{{ url_for('static', filename='tw-app.js') }}"></script>
  </body>
</html>
