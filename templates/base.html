<!doctype html>
<html lang="{{ 'en' if lang=='en' else 'ru' }}" class="h-full">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>{{ t('app_title') }}</title>

    <!-- Tailwind config BEFORE CDN + early theme boot -->
    <script>
      // Tailwind config
      window.tailwind = { config: { darkMode: 'class' } };

      // Early theme boot to avoid FOUC and ensure mobile works
      (function () {
        try {
          const saved = localStorage.getItem('theme'); // 'dark' | 'light' | null
          const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
          const enableDark = saved ? (saved === 'dark') : prefersDark;
          if (enableDark) document.documentElement.classList.add('dark');

          // Hint for native controls
          let meta = document.querySelector('meta[name="color-scheme"]');
          if (!meta) {
            meta = document.createElement('meta');
            meta.name = 'color-scheme';
            document.head.appendChild(meta);
          }
          meta.content = enableDark ? 'dark light' : 'light dark';
        } catch {}
      })();
    </script>
    <script src="https://cdn.tailwindcss.com"></script>

    <link rel="stylesheet" href="{{ url_for('static', filename='tw-app.css') }}">
  </head>
  <body class="min-h-full transition-colors">
    <div id="toast-zone" class="fixed top-4 right-4 z-50 space-y-2"></div>
    {% set flash_msg = (get_flashed_messages() or [])|first %}
    <div data-flash='{{ {"message": flash_msg, "type": "success"} | tojson if flash_msg else "" }}' class="hidden"></div>

    <header class="header-blur shadow-sm">
      <div class="mx-auto max-w-7xl px-3 sm:px-6 py-3 flex items-center justify-between">
        <a href="{{ url_for('index', lang=lang) }}" class="flex items-center gap-2 font-semibold tracking-tight text-lg">
          <span>ðŸ§­</span><span>{{ t('app_title') }}</span>
        </a>

        <nav class="hidden md:flex items-center gap-1">
          <a class="tab {{ 'tab-active' if request.args.get('tab','prices')=='prices' else '' }}" href="{{ url_for('index', tab='prices', lang=lang) }}">{{ t('nav_prices') }}</a>
          <a class="tab {{ 'tab-active' if request.args.get('tab')=='cities' else '' }}" href="{{ url_for('index', tab='cities', lang=lang) }}">{{ t('nav_cities') }}</a>
          <a class="tab {{ 'tab-active' if request.args.get('tab')=='routes' else '' }}" href="{{ url_for('index', tab='routes', lang=lang) }}">{{ t('nav_routes') }}</a>
          <a class="tab" href="{{ url_for('new_entry', lang=lang) }}">{{ t('nav_add') }}</a>
          <a class="tab" href="{{ url_for('import_csv', lang=lang) }}">{{ t('nav_import') }}</a>
        </nav>

        <div class="flex items-center gap-3">
          <!-- â± UTC & Local time -->
          <div id="clockZone" class="hidden sm:flex flex-col items-end leading-4">
            <div class="text-[11px] sm:text-xs font-mono text-zinc-600 dark:text-zinc-300" title="Coordinated Universal Time">
              UTC <span id="clockUTC">--:--:--</span>
            </div>
            <div class="text-[11px] sm:text-xs font-mono text-zinc-500 dark:text-zinc-400">
              <span id="clockLocalTz">LOCAL</span> <span id="clockLocal">--:--:--</span>
            </div>
          </div>

          <div class="hidden sm:flex rounded-lg overflow-hidden border border-zinc-200 dark:border-zinc-800">
            <a class="px-3 py-1.5 {{ 'bg-zinc-200 dark:bg-zinc-800' if lang=='en' else '' }}" href="?lang=en">EN</a>
            <a class="px-3 py-1.5 {{ 'bg-zinc-200 dark:bg-zinc-800' if lang=='ru' else '' }}" href="?lang=ru">RU</a>
          </div>
          <button id="themeToggle" class="p-2 rounded-lg hover:bg-zinc-100 dark:hover:bg-zinc-800" title="Toggle theme" aria-label="Toggle theme">ðŸŒ“</button>
          <button class="md:hidden p-2 rounded-lg hover:bg-zinc-100 dark:hover:bg-zinc-800" id="menuBtn" aria-label="Menu" aria-expanded="false">â˜°</button>
        </div>
      </div>

      <div id="mobileMenu" class="md:hidden hidden border-t border-zinc-200 dark:border-zinc-800">
        <div class="mx-auto max-w-7xl px-3 sm:px-6 py-2 grid gap-2">
          <!-- Ð’Ñ€ÐµÐ¼Ñ Ð² Ð¼Ð¾Ð±Ð¸Ð»ÑŒÐ½Ð¾Ð¼ Ð¼ÐµÐ½ÑŽ Ð¾Ð´Ð½Ð¾Ð¹ ÑÑ‚Ñ€Ð¾ÐºÐ¾Ð¹ -->
          <div class="flex items-center justify-between text-xs font-mono text-zinc-600 dark:text-zinc-300">
            <span>UTC <span id="mClockUTC">--:--:--</span></span>
            <span><span id="mClockLocalTz">LOCAL</span> <span id="mClockLocal">--:--:--</span></span>
          </div>

          <a class="tab" href="{{ url_for('index', tab='prices', lang=lang) }}">{{ t('nav_prices') }}</a>
          <a class="tab" href="{{ url_for('index', tab='cities', lang=lang) }}">{{ t('nav_cities') }}</a>
          <a class="tab" href="{{ url_for('index', tab='routes', lang=lang) }}">{{ t('nav_routes') }}</a>
          <a class="tab" href="{{ url_for('new_entry', lang=lang) }}">{{ t('nav_add') }}</a>
          <a class="tab" href="{{ url_for('import_csv', lang=lang) }}">{{ t('nav_import') }}</a>
          <div class="flex gap-2">
            <a class="flex-1 px-3 py-2 rounded-lg border border-zinc-200 dark:border-zinc-800 text-center" href="?lang=en">EN</a>
            <a class="flex-1 px-3 py-2 rounded-lg border border-zinc-200 dark:border-zinc-800 text-center" href="?lang=ru">RU</a>
          </div>
        </div>
      </div>
    </header>

    <main class="mx-auto max-w-7xl px-3 sm:px-6 py-6 space-y-6">
      {% block content %}{% endblock %}
    </main>

    <!-- Init UI after DOM is ready -->
    <script>
      document.addEventListener('DOMContentLoaded', function () {
        // Theme toggle
        const themeBtn = document.getElementById('themeToggle');
        function setTheme(next) {
          const root = document.documentElement;
          if (next === 'dark') root.classList.add('dark'); else root.classList.remove('dark');
          localStorage.setItem('theme', next);
          let m = document.querySelector('meta[name="color-scheme"]');
          if (!m) { m = document.createElement('meta'); m.name = 'color-scheme'; document.head.appendChild(m); }
          m.content = next === 'dark' ? 'dark light' : 'light dark';
        }
        themeBtn && themeBtn.addEventListener('click', (e) => {
          e.preventDefault();
          const next = document.documentElement.classList.contains('dark') ? 'light' : 'dark';
          setTheme(next);
        });

        // Mobile menu toggle (fix on phones)
        const menuBtn = document.getElementById('menuBtn');
        const mobileMenu = document.getElementById('mobileMenu');
        if (menuBtn && mobileMenu) {
          menuBtn.addEventListener('click', (e) => {
            e.preventDefault();
            mobileMenu.classList.toggle('hidden');
            const expanded = menuBtn.getAttribute('aria-expanded') === 'true';
            menuBtn.setAttribute('aria-expanded', (!expanded).toString());
          }, { passive: false });
        }

        // Clocks (UTC + local)
        function fmt(dt) {
          const y = dt.getFullYear();
          const m = String(dt.getMonth()+1).padStart(2,'0');
          const d = String(dt.getDate()).padStart(2,'0');
          const hh = String(dt.getHours()).padStart(2,'0');
          const mm = String(dt.getMinutes()).padStart(2,'0');
          const ss = String(dt.getSeconds()).padStart(2,'0');
          return `${y}-${m}-${d} ${hh}:${mm}:${ss}`;
        }
        function tzAbbr(timeZone) {
          try {
            const f = new Intl.DateTimeFormat([], {timeZone, timeZoneName:'short'});
            const parts = f.formatToParts(new Date());
            const tz = parts.find(p => p.type === 'timeZoneName');
            return tz ? tz.value : timeZone;
          } catch { return timeZone; }
        }
        const localTz = Intl.DateTimeFormat().resolvedOptions().timeZone || 'Local';
        const localLabel = tzAbbr(localTz);

        const elUTC = document.getElementById('clockUTC');
        const elLocal = document.getElementById('clockLocal');
        const elLocalTz = document.getElementById('clockLocalTz');
        const mUTC = document.getElementById('mClockUTC');
        const mLocal = document.getElementById('mClockLocal');
        const mLocalTz = document.getElementById('mClockLocalTz');
        if (elLocalTz) elLocalTz.textContent = localLabel;
        if (mLocalTz) mLocalTz.textContent = localLabel;

        function tick() {
          const now = new Date();
          const utc = new Date(now.getTime() + now.getTimezoneOffset()*60000);
          if (elUTC)   elUTC.textContent = fmt(utc);
          if (elLocal) elLocal.textContent = fmt(now);
          if (mUTC)    mUTC.textContent = fmt(utc);
          if (mLocal)  mLocal.textContent = fmt(now);
        }
        tick();
        setInterval(tick, 1000);
      });
    </script>

    <script src="{{ url_for('static', filename='tw-app.js') }}"></script>
  </body>
</html>
